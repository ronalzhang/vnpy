<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校长的量化系统 - 量化交易</title>
    <!-- 添加favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <!-- 替换为更稳定的CDN -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- 引用量化交易专用样式 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/quantitative.css') }}">
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body class="quantitative-page">
    <!-- 重新设计的导航栏 -->
    <header>
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid px-4">
                <div class="navbar-content w-100 d-flex justify-content-between align-items-center">
                    <!-- 左侧：品牌名和系统状态 -->
                    <div class="navbar-left d-flex align-items-center">
                        <a class="navbar-brand me-4" href="/">
                            <i class="fas fa-chart-line me-2"></i>
                                校长的量化系统
                            </a>
                        <div class="system-status d-flex align-items-center">
                                                        <span class="status-dot offline" id="system-status-indicator"></span>
                            <span id="system-status-text" class="me-3">离线</span>
                            <small id="current-time" class="text-white-50">2025/7/1 09:05:27</small>
                        </div>
                    </div>
                    
                    <!-- 右侧：导航菜单 -->
                    <ul class="navbar-nav d-flex flex-row">
                        <li class="nav-item me-3">
                            <a class="nav-link" href="/">
                                <i class="fas fa-home me-1"></i>
                                <span class="d-none d-md-inline">市场数据</span>
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link active" href="/quantitative.html">
                                <i class="fas fa-robot me-1"></i>
                                <span class="d-none d-md-inline">量化交易</span>
                            </a>
                        </li>
                        <li class="nav-item me-3">
                            <a class="nav-link" href="/arbitrage.html">
                                <i class="fas fa-exchange-alt me-1"></i>
                                <span class="d-none d-md-inline">套利系统</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/operations-log.html">
                                <i class="fas fa-list-alt me-1"></i>
                                <span class="d-none d-md-inline">日志</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- 主要内容区域 - 采用更紧凑的布局 -->
    <div class="container-fluid px-4 py-3">
        
        <!-- 策略进化实时监控 - 优化为更紧凑的显示 -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card border-0">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h6 class="mb-0 d-flex align-items-center">
                            <i class="fas fa-chart-line me-2 text-primary"></i>
                            策略进化实时监控
                        </h6>
                        <div class="d-flex align-items-center">
                            <span class="badge me-2" id="evolutionLogCount">0 条记录</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="showAllLogs()">
                                <i class="fas fa-list me-1"></i>查看全部
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- 进化日志滚动显示 -->
                        <div class="evolution-ticker-container" style="height: 100px;">
                            <div class="evolution-ticker" id="evolutionTicker">
                                <div class="ticker-item">
                                    <span class="text-muted">正在加载策略进化日志...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 核心控制面板 - 采用4列布局更紧凑 -->
        <div class="row mb-3 control-modules">
            <!-- 系统控制台 -->
            <div class="col-xl-3 col-lg-6 mb-3">
                <div class="card system-control-card h-100">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-3 d-flex align-items-center">
                            <i class="fas fa-cog me-2"></i> 系统控制
                        </h6>
                        
                        <!-- 控制项目 -->
                        <div class="control-items">
                            <div class="control-item d-flex justify-content-between align-items-center mb-2">
                                <div class="d-flex align-items-center">
                                    <span class="status-dot offline me-2" id="systemStatusDot"></span>
                                    <small>系统状态</small>
                            </div>
                                <span class="badge" id="systemStatusBadge">离线</span>
                        </div>
                        
                            <div class="control-item d-flex justify-content-between align-items-center mb-2">
                                <small>量化系统</small>
                                <button id="systemToggle" class="btn-toggle" onclick="toggleSystem()"></button>
                        </div>
                        
                            <div class="control-item d-flex justify-content-between align-items-center mb-2">
                                <small>真实交易</small>
                                <button id="autoTradingToggle" class="btn-toggle" onclick="toggleAutoTrading()"></button>
                        </div>
                        
                            <div class="control-item d-flex justify-content-between align-items-center">
                                <small>策略管理</small>
                                <button class="btn btn-sm btn-outline-primary" onclick="showStrategyManagement()">
                                    <i class="fas fa-cogs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 账户总览 -->
            <div class="col-xl-3 col-lg-6 mb-3">
                <div class="card account-card h-100">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-3 d-flex align-items-center">
                            <i class="fas fa-wallet me-2"></i> 账户总览
                        </h6>
                        
                        <div class="account-metrics">
                            <div class="metric-row d-flex justify-content-between mb-2">
                                <small class="text-muted">总资产</small>
                                <span class="fw-bold" id="totalBalance">-</span>
                            </div>
                            <div class="metric-row d-flex justify-content-between mb-2">
                                <small class="text-muted">今日盈亏</small>
                                <span class="fw-bold text-success" id="dailyPnl">-</span>
                            </div>
                            <div class="metric-row d-flex justify-content-between mb-2">
                                <small class="text-muted">今日收益率</small>
                                <span class="fw-bold" id="dailyReturn">-</span>
                        </div>
                            <div class="metric-row d-flex justify-content-between">
                                <small class="text-muted">今日交易</small>
                                <span class="fw-bold" id="dailyTrades">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 交易所状态 -->
            <div class="col-xl-3 col-lg-6 mb-3">
                <div class="card exchange-card h-100">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-3 d-flex align-items-center">
                            <i class="fas fa-link me-2"></i> 交易所状态
                        </h6>
                        
                        <div id="exchangeStatus">
                            <div class="exchange-item d-flex justify-content-between align-items-center mb-2">
                                <div class="d-flex align-items-center">
                                    <span class="status-dot online me-2"></span>
                                    <small>币安</small>
                            </div>
                                <small class="text-success">25ms</small>
                            </div>
                            <div class="exchange-item d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">API权限</small>
                                <span class="badge bg-success">现货</span>
                            </div>
                            <div class="exchange-item d-flex justify-content-between align-items-center">
                                <small class="text-muted">最后更新</small>
                                <small id="lastUpdate">刚刚</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
            <!-- 性能监控 -->
            <div class="col-xl-3 col-lg-6 mb-3">
                <div class="card h-100">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-3 d-flex align-items-center">
                            <i class="fas fa-tachometer-alt me-2"></i> 性能监控
                        </h6>
                        
                        <div class="performance-metrics">
                            <div class="metric-row d-flex justify-content-between mb-2">
                                <small class="text-muted">活跃策略</small>
                                <span class="fw-bold text-primary" id="activeStrategies">-</span>
                                </div>
                            <div class="metric-row d-flex justify-content-between mb-2">
                                <small class="text-muted">胜率</small>
                                <span class="fw-bold text-success" id="winRate">-</span>
                                    </div>
                            <div class="metric-row d-flex justify-content-between mb-2">
                                <small class="text-muted">最大回撤</small>
                                <span class="fw-bold text-warning" id="maxDrawdown">-</span>
                                </div>
                            <div class="metric-row d-flex justify-content-between">
                                <small class="text-muted">夏普比率</small>
                                <span class="fw-bold" id="sharpeRatio">-</span>
                            </div>
                            </div>
                        </div>
                    </div>
                                </div>
                            </div>
        

        
        <!-- 策略管理 - 占满整个浏览器宽度 -->
        <div class="row">
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center py-3">
                        <h6 class="mb-0 d-flex align-items-center">
                            <i class="fas fa-brain me-2"></i> 量化策略管理
                        </h6>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="showAllLogs()">
                                <i class="fas fa-list me-1"></i>滚动日志
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-3">
                        <div class="row" id="strategiesContainer">
                            <!-- 策略卡片将通过JavaScript动态生成 -->
                            <div class="col-12">
                                <div class="alert alert-info mb-0" id="jsTestStatus">
                                    <i class="fas fa-spinner fa-spin me-2"></i>正在加载策略数据...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 底部四个功能模块 - 重新设计统一样式 -->
        <div class="row g-3 mb-4">
            <!-- 收益曲线 -->
            <div class="col-xl-3 col-lg-6 col-md-6">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-header bg-gradient-primary text-white py-3 border-0">
                        <h6 class="mb-0 d-flex align-items-center fw-bold">
                            <i class="fas fa-chart-line me-2"></i> 收益曲线
                        </h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="performance-chart-container" style="height: 220px; position: relative;">
                            <canvas id="performanceChart2" style="display: none;"></canvas>
                            <div class="chart-placeholder" id="performanceChartPlaceholder">
                                <div class="loading-content text-center">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted small mb-0">正在加载收益数据...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 资产增长 -->
            <div class="col-xl-3 col-lg-6 col-md-6">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-header bg-gradient-success text-white py-3 border-0 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 d-flex align-items-center fw-bold">
                            <i class="fas fa-chart-area me-2"></i> 资产增长
                        </h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-light btn-sm text-dark" onclick="toggleBalanceChart('7')" style="font-size: 0.75rem;">7天</button>
                            <button class="btn btn-warning btn-sm active" onclick="toggleBalanceChart('30')" style="font-size: 0.75rem;">30天</button>
                    </div>
                        </div>
                    <div class="card-body p-3">
                        <div class="balance-chart-container" style="height: 140px; position: relative;">
                            <canvas id="balanceChart2" style="display: none;"></canvas>
                            <div class="chart-placeholder" id="balanceChartPlaceholder">
                                <div class="loading-content text-center">
                                    <div class="spinner-border text-success mb-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                    </div>
                                    <p class="text-muted small mb-0">正在加载资产数据...</p>
                </div>
            </div>
        </div>
        
                        <!-- 里程碑展示 - 优化布局 -->
                        <div class="milestones-container mt-3">
                            <div class="row g-1 text-center">
                                <div class="col-4">
                                    <div class="milestone-card p-2 rounded bg-light">
                                        <div class="milestone-value text-dark fw-bold small">10U</div>
                                        <div class="milestone-label text-muted" style="font-size: 0.7rem;">起始</div>
                    </div>
                        </div>
                                <div class="col-4">
                                    <div class="milestone-card p-2 rounded bg-warning bg-opacity-25">
                                        <div class="milestone-value text-dark fw-bold small" id="currentBalance2">12.3U</div>
                                        <div class="milestone-label text-muted" style="font-size: 0.7rem;">当前</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="milestone-card p-2 rounded bg-primary bg-opacity-25">
                                        <div class="milestone-value text-dark fw-bold small">100K</div>
                                        <div class="milestone-label text-muted" style="font-size: 0.7rem;">目标</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 最新信号 -->
            <div class="col-xl-3 col-lg-6 col-md-6">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-header bg-gradient-info text-white py-3 border-0">
                        <h6 class="mb-0 d-flex align-items-center fw-bold">
                            <i class="fas fa-signal me-2"></i> 最新信号
                        </h6>
                        </div>
                    <div class="card-body p-3">
                        <div class="signals-container" style="height: 220px;">
                            <div class="signals-list h-100" style="overflow-y: auto;">
                                <div id="signalsContainer2">
                                    <div class="loading-content text-center h-100 d-flex flex-column justify-content-center">
                                        <div class="spinner-border text-info mb-3" role="status">
                                            <span class="visually-hidden">Loading...</span>
                    </div>
                                        <p class="text-muted small mb-0">正在加载交易信号...</p>
                        </div>
                                    </div>
                                </div>
                                    </div>
                                </div>
                                    </div>
                                </div>
            
            <!-- 持仓管理 -->
            <div class="col-xl-3 col-lg-6 col-md-6">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-header bg-gradient-warning text-white py-3 border-0">
                        <h6 class="mb-0 d-flex align-items-center fw-bold">
                            <i class="fas fa-wallet me-2"></i> 持仓管理
                        </h6>
                            </div>
                    <div class="card-body p-3">
                        <div class="positions-container" style="height: 220px;">
                            <div class="positions-list h-100" style="overflow-y: auto;">
                                <div id="positionsContainer">
                                    <div class="loading-content text-center h-100 d-flex flex-column justify-content-center">
                                        <div class="spinner-border text-warning mb-3" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="text-muted small mb-0">正在加载持仓数据...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 策略配置弹窗模态框 -->
    <div class="modal fade" id="strategyConfigModal" tabindex="-1" aria-labelledby="strategyConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="strategyConfigModalLabel">
                        <i class="fas fa-cog"></i> 策略配置
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="strategyConfigForm">
                        <input type="hidden" id="strategyId" name="strategyId">
                        
                        <!-- 基本信息 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="strategyName" class="form-label">策略名称</label>
                                <input type="text" class="form-control" id="strategyName" name="strategyName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="strategySymbol" class="form-label">交易对</label>
                                <select class="form-select" id="strategySymbol" name="strategySymbol" required>
                                    <option value="BTC/USDT">BTC/USDT</option>
                                    <option value="ETH/USDT">ETH/USDT</option>
                                    <option value="ADA/USDT">ADA/USDT</option>
                                    <option value="SOL/USDT">SOL/USDT</option>
                                    <option value="DOGE/USDT">DOGE/USDT</option>
                                    <option value="XRP/USDT">XRP/USDT</option>
                                </select>
                            </div>
                        </div>

                        <!-- 策略类型 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="strategyType" class="form-label">策略类型</label>
                                <select class="form-select" id="strategyType" name="strategyType" disabled>
                                    <option value="momentum">动量策略</option>
                                    <option value="mean_reversion">均值回归</option>
                                    <option value="breakout">突破策略</option>
                                    <option value="grid_trading">网格交易</option>
                                    <option value="high_frequency">高频交易</option>
                                    <option value="trend_following">趋势跟踪</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="strategyEnabled" class="form-label">策略状态</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" role="switch" id="strategyEnabled" name="strategyEnabled">
                                    <label class="form-check-label" for="strategyEnabled">启用策略</label>
                                </div>
                            </div>
                        </div>

                        <!-- 策略参数 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">策略参数</h6>
                            </div>
                            <div class="card-body">
                                <div id="strategyParameters">
                                    <!-- 动态参数表单将在这里生成 -->
                                </div>
                            </div>
                        </div>

                        <!-- 策略统计 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">策略统计</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h5 mb-1" id="strategyTotalReturn">-</div>
                                            <small class="text-muted">总收益率</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h5 mb-1" id="strategyWinRate">-</div>
                                            <small class="text-muted">成功率</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h5 mb-1" id="strategyTotalTrades">-</div>
                                            <small class="text-muted">交易次数</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h5 mb-1" id="strategyDailyReturn">-</div>
                                            <small class="text-muted">日收益率</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveStrategyConfig">保存配置</button>
                    <button type="button" class="btn btn-warning" id="resetStrategyParams">重置参数</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 策略日志弹窗 -->
    <div class="modal fade" id="strategyLogsModal" tabindex="-1" aria-labelledby="strategyLogsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="strategyLogsModalLabel">
                        <i class="fas fa-history"></i> 策略日志
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 🔥 新增：多标签页策略日志结构 -->
                    <div id="strategyLogTabs">
                        <!-- 标签页内容将由JavaScript动态生成 -->
                        <div class="text-center p-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                            <p class="text-muted">正在初始化日志标签页...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-info" id="exportLogs">导出日志</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 策略管理配置弹窗 -->
    <div class="modal fade" id="strategyManagementModal" tabindex="-1" aria-labelledby="strategyManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="strategyManagementModalLabel">
                        <i class="fas fa-cogs"></i> 策略管理配置
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="strategyManagementForm">
                        <!-- 策略运行状态仪表盘 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-pie"></i> 策略运行状态
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- 简化的状态显示，移除复杂配置 -->
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <div class="metric-value" id="currentActiveStrategies">-</div>
                                                <div class="metric-label">活跃策略</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric-value text-success" id="realTradingStrategiesCount">-</div>
                                                <div class="metric-label">真实交易</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric-value text-info" id="validationStrategiesCount">-</div>
                                                <div class="metric-label">验证交易</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric-value text-muted" id="totalStrategiesCount">-</div>
                                                <div class="metric-label">总策略数</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 注释：策略进化配置已整合到四层进化系统配置中 -->

                        <!-- 🔥 四层进化系统配置 -->
                        <div class="config-section">
                            <h3>🚀 四层策略进化系统配置</h3>
                            
                            <!-- 层级数量配置 -->
                            <div class="tier-config-group">
                                <h4>📊 层级数量配置</h4>
                                <div class="config-grid">
                                    <div class="config-item">
                                        <label for="high_freq_pool_size">高频池大小</label>
                                        <input type="number" id="high_freq_pool_size" name="high_freq_pool_size" min="100" max="5000" step="100">
                                        <small>第2层：参与高频进化的策略数量</small>
                            </div>
                                    <div class="config-item">
                                        <label for="display_strategies_count">前端显示数量</label>
                                        <input type="number" id="display_strategies_count" name="display_strategies_count" min="10" max="50" step="1">
                                        <small>第3层：前端页面显示的策略数量</small>
                                    </div>
                                    <div class="config-item">
                                        <label for="real_trading_count">实盘交易数量</label>
                                        <input type="number" id="real_trading_count" name="real_trading_count" min="1" max="10" step="1">
                                        <small>第4层：符合条件的实盘交易策略数量</small>
                                </div>
                            </div>
                        </div>

                            <!-- 🔧 统一进化频率配置 -->
                            <div class="tier-config-group">
                                <h4>⏰ 统一进化频率配置</h4>
                                <p><small>🎯 已删除重复的传统进化间隔配置，统一使用Modern Strategy Manager的四层配置</small></p>
                                <div class="config-grid">
                                    <div class="config-item">
                                        <label for="low_freq_interval_hours">策略池进化间隔 (小时)</label>
                                        <input type="number" id="low_freq_interval_hours" name="low_freq_interval_hours" min="6" max="72" step="6">
                                        <small>第1层：全部策略低频进化间隔</small>
                                    </div>
                                    <div class="config-item">
                                        <label for="high_freq_interval_minutes">高频池进化间隔 (分钟)</label>
                                        <input type="number" id="high_freq_interval_minutes" name="high_freq_interval_minutes" min="10" max="180" step="10">
                                        <small>第2层：高频池策略进化间隔</small>
                                    </div>
                                    <div class="config-item">
                                        <label for="display_interval_minutes">前端显示进化间隔 (分钟)</label>
                                        <input type="number" id="display_interval_minutes" name="display_interval_minutes" min="1" max="30" step="1">
                                        <small>第3层：前端策略持续进化间隔</small>
                                    </div>
                                </div>
                                    </div>

                            <!-- 策略淘汰配置 -->
                            <div class="tier-config-group">
                                <h4>⚡ 策略淘汰配置</h4>
                                <div class="config-grid">
                                    <div class="config-item">
                                        <label for="minScore">淘汰评分阈值 (分)</label>
                                        <input type="number" id="minScore" name="minScore" min="5" max="50" step="5">
                                        <small>低于此评分的策略将被淘汰（当前：10分）</small>
                                    </div>
                                    <div class="config-item">
                                        <label for="eliminationDays">淘汰检查周期 (天)</label>
                                        <input type="number" id="eliminationDays" name="eliminationDays" min="1" max="30" step="1">
                                        <small>每隔几天检查一次淘汰条件</small>
                                    </div>
                                </div>
                                    </div>

                                                        <!-- 🔥 统一验证交易配置 -->
                            <div class="tier-config-group">
                                <h4>🔬 统一验证交易配置</h4>
                                <p><small>🎯 进化本质就是参数修改，无论是自动进化还是手动调整，都使用统一的验证机制</small></p>
                                <div class="config-grid">
                                    <div class="config-item">
                                        <label for="unified_validation_count">统一验证交易次数</label>
                                        <input type="number" id="unified_validation_count" name="unified_validation_count" min="2" max="8" step="1">
                                        <small>所有参数调整后的验证交易次数（高分策略=4次，中等=3次，低分=2次）</small>
                                    </div>
                                    <div class="config-item">
                                        <label for="validation_score_threshold_high">高分策略门槛</label>
                                        <input type="number" id="validation_score_threshold_high" name="validation_score_threshold_high" min="70" max="90" step="5">
                                        <small>80分以上策略使用4次验证交易</small>
                                    </div>
                                    <div class="config-item">
                                        <label for="validation_score_threshold_mid">中等策略门槛</label>
                                        <input type="number" id="validation_score_threshold_mid" name="validation_score_threshold_mid" min="50" max="80" step="5">
                                        <small>60分以上策略使用3次验证交易</small>
                                </div>
                            </div>
                        </div>

                            <!-- 交易金额配置 -->
                            <div class="tier-config-group">
                                <h4>💰 交易金额配置</h4>
                                <div class="config-grid">
                                    <div class="config-item">
                                        <label for="validation_amount">验证交易金额 (USDT)</label>
                                        <input type="number" id="validation_amount" name="validation_amount" min="10" max="200" step="10">
                                        <small>验证交易的单笔金额</small>
                            </div>
                                    <div class="config-item">
                                        <label for="real_trading_amount">实盘交易金额 (USDT)</label>
                                        <input type="number" id="real_trading_amount" name="real_trading_amount" min="50" max="1000" step="50">
                                        <small>实盘交易的单笔金额</small>
                                    </div>
                                    <div class="config-item">
                                        <label for="real_trading_score_threshold">实盘交易评分门槛</label>
                                        <input type="number" id="real_trading_score_threshold" name="real_trading_score_threshold" min="50" max="90" step="5">
                                        <small>策略进入实盘交易的最低评分</small>
                                    </div>
                                    </div>
                                </div>

                            <!-- 🔧 新增：实盘交易控制参数 -->
                            <div class="tier-config-group">
                                <h4>🎯 实盘交易控制参数</h4>
                                <div class="config-grid">
                                    <div class="config-item">
                                        <label for="real_trading_enabled">启用实盘交易</label>
                                        <select id="real_trading_enabled" name="real_trading_enabled">
                                            <option value="false">禁用</option>
                                            <option value="true">启用</option>
                                        </select>
                                        <small>全局实盘交易开关</small>
                                    </div>
                                    <div class="config-item">
                                        <label for="min_simulation_days">最少模拟天数</label>
                                        <input type="number" id="min_simulation_days" name="min_simulation_days" min="1" max="30" step="1">
                                        <small>策略进入实盘前的最少模拟交易天数</small>
                                    </div>
                                    <div class="config-item">
                                        <label for="min_sim_win_rate">最低模拟胜率 (%)</label>
                                        <input type="number" id="min_sim_win_rate" name="min_sim_win_rate" min="50" max="95" step="5">
                                        <small>策略进入实盘交易的最低胜率要求</small>
                                    </div>
                                    <div class="config-item">
                                        <label for="min_sim_total_pnl">最低模拟盈利 (USDT)</label>
                                        <input type="number" id="min_sim_total_pnl" name="min_sim_total_pnl" min="0" max="100" step="1">
                                        <small>策略进入实盘交易的最低累计盈利</small>
                                    </div>
                                </div>
                            </div>

                            <!-- 四层系统状态显示 -->
                            <div class="tier-config-group">
                                <h4>📈 四层系统状态</h4>
                                <div class="tier-status-grid">
                                    <div class="tier-status-card">
                                        <div class="tier-header">第1层 - 策略池</div>
                                        <div class="tier-stats">
                                            <span class="stat-item">策略数量: <span id="tier1_count">-</span></span>
                                            <span class="stat-item">理论进化: <span id="tier1_evolutions">-</span>/小时</span>
                                    </div>
                                    </div>
                                    <div class="tier-status-card">
                                        <div class="tier-header">第2层 - 高频池</div>
                                        <div class="tier-stats">
                                            <span class="stat-item">策略数量: <span id="tier2_count">-</span></span>
                                            <span class="stat-item">理论进化: <span id="tier2_evolutions">-</span>/小时</span>
                                </div>
                            </div>
                                    <div class="tier-status-card">
                                        <div class="tier-header">第3层 - 前端显示</div>
                                        <div class="tier-stats">
                                            <span class="stat-item">策略数量: <span id="tier3_count">-</span></span>
                                            <span class="stat-item">理论进化: <span id="tier3_evolutions">-</span>/小时</span>
                        </div>
                            </div>
                                    <div class="tier-status-card">
                                        <div class="tier-header">第4层 - 实盘交易</div>
                                        <div class="tier-stats">
                                            <span class="stat-item">策略数量: <span id="tier4_count">-</span></span>
                                            <span class="stat-item">评分门槛: <span id="tier4_threshold">-</span>分</span>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" onclick="resetManagementConfig()">恢复默认</button>
                    <button type="button" class="btn btn-primary" onclick="saveManagementConfig()">
                        <i class="fas fa-save me-1"></i>保存配置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志查看弹窗 -->
    <div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logsModalLabel">
                        <i class="fas fa-list-alt"></i> 策略日志
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 日志筛选 -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="logTypeFilter">
                                <option value="all">所有日志</option>
                                <option value="evolution">进化日志</option>
                                <option value="validation">验证交易</option>
                                <option value="real_trading">真实交易</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="strategyFilter">
                                <option value="">所有策略</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="dateFilter">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" onclick="applyLogFilters()">
                                <i class="fas fa-search"></i> 筛选
                            </button>
                        </div>
                    </div>
                    
                    <!-- 日志内容 -->
                    <div id="logsContent">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">正在加载日志...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="exportLogs()">
                        <i class="fas fa-download"></i> 导出
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <!-- 量化交易专用JavaScript -->
    <script src="{{ url_for('static', filename='js/quantitative.js') }}"></script>
    
    <script>
        // ==================== 强制量化系统初始化 ====================
        let quantitativeSystem;
        let isInitialized = false;
        
        // 立即强制初始化数据加载
        function forceLoadStrategies() {
            console.log('🚀 强制加载策略数据...');
            
            const jsTestStatus = document.getElementById('jsTestStatus');
            if (jsTestStatus) {
                jsTestStatus.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>连接API中...';
            }
            
            // 直接调用API
            fetch('/api/quantitative/strategies')
                .then(response => {
                    console.log('API响应状态:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API数据:', data);
                    
                    if (data.status === 'success' && data.data) {
                        const strategies = data.data;
                        console.log(`✅ 成功加载 ${strategies.length} 个策略`);
                        
                        // 🔧 修复：使用quantitativeSystem实例的方法
                        if (window.quantitativeSystem) {
                            window.quantitativeSystem.strategies = strategies;
                            window.quantitativeSystem.renderStrategies();
                        } else if (window.app) {
                            window.app.strategies = strategies;
                            window.app.renderStrategies();
                        } else {
                            console.error('❌ 未找到量化系统实例');
                        }
                        
                        if (jsTestStatus) {
                            jsTestStatus.innerHTML = `<i class="fas fa-check me-2 text-success"></i>成功加载 ${strategies.length} 个策略`;
                        }
            } else {
                        throw new Error('API返回数据格式错误');
                    }
                })
                .catch(error => {
                    console.error('❌ 策略加载失败:', error);
                    
                    if (jsTestStatus) {
                        jsTestStatus.innerHTML = `<i class="fas fa-exclamation-triangle me-2 text-danger"></i>数据加载失败: ${error.message}`;
                    }
                });
        }
        
                // 🗑️ 删除重复的策略卡生成函数，使用quantitative.js中的统一逻辑
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('⚡ 量化系统页面开始初始化...');
            
            // 🔧 防止重复初始化
            if (window.quantInitialized) {
                console.log('⚠️ 页面已初始化，跳过重复初始化');
                return;
            }
            window.quantInitialized = true;
            
            // 🔧 严格的加载控制：只初始化一次
            let initializationTimer = null;
            
            function initializeOnce() {
                if (initializationTimer) {
                    clearTimeout(initializationTimer);
                }
                
                initializationTimer = setTimeout(() => {
                    console.log('🚀 开始策略数据加载...');
                    forceLoadStrategies();
                    
                    // 🔧 修复：大幅延迟底部模块加载，避免与主要功能冲突
                    setTimeout(() => {
                        if (!window.bottomModulesLoading) {
                            console.log('🔄 开始底部模块数据加载...');
                            loadBottomModulesData();
                        }
                    }, 10000);  // 延迟10秒加载，确保主功能稳定
                    
                }, 1000);
            }
            
            // 🔧 只执行一次初始化
            initializeOnce();
            
            // 🔧 移除可能导致重复调用的全局对象创建
            // 创建量化系统实例（如果存在）
            if (typeof QuantitativeSystem !== 'undefined' && !window.quantitativeSystem) {
                try {
                    quantitativeSystem = new QuantitativeSystem();
                    window.quantitativeSystem = quantitativeSystem;
                    window.app = quantitativeSystem;
                    console.log('✅ QuantitativeSystem 实例已创建');
                } catch (e) {
                    console.warn('⚠️ QuantitativeSystem 创建失败:', e);
                }
            }
            
            // 🔧 移除状态轮询，减少API调用
            // 启动状态管理器（如果存在）
            if (typeof GlobalStatusManager !== 'undefined' && !window.globalStatusManager) {
                try {
                    const statusManager = new GlobalStatusManager();
                    // 🔧 减少轮询频率，避免CPU占用过高
                    statusManager.startStatusPolling && statusManager.startStatusPolling(30000); // 30秒轮询一次
                    window.globalStatusManager = statusManager;
                    console.log('✅ GlobalStatusManager 已启动（30秒轮询）');
                } catch (e) {
                    console.warn('⚠️ GlobalStatusManager 启动失败:', e);
                }
            }
            
            // 🔧 启用自动保存功能
            enableAutoSave();
            
            // 标记初始化完成
            isInitialized = true;
            console.log('✅ 量化系统初始化完成');
        });
        
        // 强制刷新函数
        function refreshStrategies() {
            forceLoadStrategies();
        }
        
        // 策略配置函数
        function configStrategy(strategyId) {
            console.log('配置策略:', strategyId);
            
            // 设置模态框标题
            const modalTitle = document.getElementById('strategyConfigModalLabel');
            if (modalTitle) {
                modalTitle.innerHTML = `<i class="fas fa-cog"></i> 策略配置 - ${strategyId.slice(-8)}`;
            }
            
            // 显示策略配置模态框
            const modal = new bootstrap.Modal(document.getElementById('strategyConfigModal'));
                modal.show();
            
            // 立即加载策略配置数据
            loadStrategyConfigData(strategyId);
        }
        
        // 加载策略配置数据
        function loadStrategyConfigData(strategyId) {
            // 设置策略ID隐藏字段
            const strategyIdInput = document.getElementById('strategyId');
            if (strategyIdInput) {
                strategyIdInput.value = strategyId;
            }
            
            // 调用策略详情API加载配置
            fetch(`/api/quantitative/strategies`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.data) {
                        const strategy = data.data.find(s => s.id === strategyId);
                        if (strategy) {
                            populateStrategyForm(strategy);
            } else {
                            throw new Error('未找到策略数据');
                        }
                    } else {
                        throw new Error('API返回数据格式错误');
                    }
                })
                .catch(error => {
                    console.error('❌ 策略配置加载失败:', error);
                    // 显示错误提示但仍允许编辑
                    const form = document.getElementById('strategyConfigForm');
                    if (form) {
                        form.insertAdjacentHTML('afterbegin', `
                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                配置数据加载失败: ${error.message}，请手动输入配置信息。
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `);
                    }
                });
        }
        
        // 填充策略表单数据
        function populateStrategyForm(strategy) {
            // 基本信息
            const strategyName = document.getElementById('strategyName');
            if (strategyName) strategyName.value = strategy.name || '';
            
            const strategySymbol = document.getElementById('strategySymbol');
            if (strategySymbol) strategySymbol.value = strategy.symbol || 'BTC/USDT';
            
            const strategyType = document.getElementById('strategyType');
            if (strategyType) strategyType.value = strategy.strategy_type || 'momentum';
            
            const strategyEnabled = document.getElementById('strategyEnabled');
            if (strategyEnabled) strategyEnabled.checked = strategy.enabled || false;
            
            // 策略统计
            const totalReturn = document.getElementById('strategyTotalReturn');
            if (totalReturn) totalReturn.textContent = `${(strategy.total_return_rate || 0).toFixed(2)}%`;
            
            const winRate = document.getElementById('strategyWinRate');
            if (winRate) winRate.textContent = `${(strategy.win_rate || 0).toFixed(1)}%`;
            
            const totalTrades = document.getElementById('strategyTotalTrades');
            if (totalTrades) totalTrades.textContent = strategy.total_trades || 0;
            
            const dailyReturn = document.getElementById('strategyDailyReturn');
            if (dailyReturn) dailyReturn.textContent = `${(strategy.daily_return_rate || 0).toFixed(2)}%`;
            
            // 策略参数
            populateStrategyParameters(strategy.parameters || {});
        }
        
        // 填充策略参数
        function populateStrategyParameters(parameters) {
            const container = document.getElementById('strategyParameters');
            if (!container) return;
            
            if (Object.keys(parameters).length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-cog me-2"></i>
                        暂无可配置参数
                </div>
                `;
                return;
            }
            
            const parametersHtml = Object.entries(parameters).map(([key, value]) => {
                return `
                    <div class="row mb-3">
                    <div class="col-md-6">
                            <label for="param_${key}" class="form-label">${key}</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="param_${key}" 
                                   name="param_${key}" 
                                   value="${value}" 
                                   step="0.01">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <small class="text-muted">当前值: ${value}</small>
                    </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = parametersHtml;
        }
        
        // 显示策略日志函数
        function showStrategyLogs(strategyId) {
            console.log('显示策略日志:', strategyId);
            
            // 设置模态框标题
            const modalTitle = document.getElementById('strategyLogsModalLabel');
            if (modalTitle) {
                modalTitle.innerHTML = `<i class="fas fa-history"></i> 策略日志 - ${strategyId.slice(-8)}`;
            }
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('strategyLogsModal'));
            modal.show();
            
            // 立即加载日志数据
            loadStrategyLogData(strategyId);
        }
        
        // 加载策略日志数据
        function loadStrategyLogData(strategyId) {
            const container = document.getElementById('strategyLogTabs');
            if (!container) return;
            
            // 显示加载状态
            container.innerHTML = `
                <div class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                    <p class="text-muted">正在加载策略日志...</p>
                </div>
            `;
            
                        // 调用进化日志API（修复数据源）
            fetch(`/api/quantitative/evolution-log?strategy_id=${strategyId}&limit=50`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success || data.status === 'success') {
                        const logs = data.logs || data.data || [];
                        // 转换数据格式以适配显示逻辑（使用正确字段名）
                        const formattedLogs = logs.map(log => ({
                            ...log,
                            log_type: log.evolution_type || 'evolution',
                            action: log.action_type || '策略进化',
                            trigger_reason: log.trigger_reason || log.evolution_reason || log.notes,
                            timestamp: log.timestamp,
                            details: `Gen${log.generation}/Cycle${log.cycle} - ${log.action_type} - ${log.trigger_reason || '无原因'}`,
                            pnl: log.improvement || null
                        }));
                        displayStrategyLogTabs(formattedLogs, strategyId);
                    } else {
                        throw new Error('API返回数据格式错误');
                    }
                })
                .catch(error => {
                    console.error('❌ 策略日志加载失败:', error);
                    container.innerHTML = `
                        <div class="text-center p-4">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                            <p class="text-danger">日志加载失败: ${error.message}</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadStrategyLogData('${strategyId}')">
                                <i class="fas fa-retry me-1"></i>重试
                            </button>
                        </div>
                    `;
                });
        }
        
        // 显示策略日志标签页
        function displayStrategyLogTabs(logs, strategyId) {
            const container = document.getElementById('strategyLogTabs');
            if (!container) return;
            
            // 按类型分组日志
            const logsByType = {
                all: logs,
                evolution: logs.filter(log => log.log_type === 'evolution'),
                validation: logs.filter(log => log.log_type === 'validation' || log.log_type === 'trading'),
                real_trading: logs.filter(log => log.log_type === 'real_trading')
            };
            
            // 生成标签页HTML
            const tabsHtml = `
                <div class="row mb-3">
                    <div class="col-12">
                        <ul class="nav nav-tabs" id="logTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-logs" type="button" role="tab">
                                    全部日志 (${logsByType.all.length})
                                </button>
                                </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="evolution-tab" data-bs-toggle="tab" data-bs-target="#evolution-logs" type="button" role="tab">
                                    进化日志 (${logsByType.evolution.length})
                                </button>
                                </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="validation-tab" data-bs-toggle="tab" data-bs-target="#validation-logs" type="button" role="tab">
                                    验证交易 (${logsByType.validation.length})
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="real-tab" data-bs-toggle="tab" data-bs-target="#real-logs" type="button" role="tab">
                                    真实交易 (${logsByType.real_trading.length})
                                </button>
                                </li>
                            </ul>
                    </div>
                </div>
                
                <div class="tab-content" id="logTabsContent">
                    ${generateLogTabContent('all-logs', logsByType.all, 'all', true)}
                    ${generateLogTabContent('evolution-logs', logsByType.evolution, 'evolution')}
                    ${generateLogTabContent('validation-logs', logsByType.validation, 'validation')}
                    ${generateLogTabContent('real-logs', logsByType.real_trading, 'real_trading')}
                </div>
            `;
            
            container.innerHTML = tabsHtml;
        }
        
        // 生成日志标签页内容 - 优化UI样式
        function generateLogTabContent(tabId, logs, type, isActive = false) {
            const activeClass = isActive ? ' show active' : '';
            
            if (logs.length === 0) {
                return `
                    <div class="tab-pane fade${activeClass}" id="${tabId}" role="tabpanel">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                            <p>暂无${getLogTypeName(type)}记录</p>
                </div>
                </div>
                `;
            }
            
            const logsHtml = logs.map((log, index) => {
                const logTime = new Date(log.timestamp || log.created_at).toLocaleString();
                const logTypeClass = getLogTypeClass(log.log_type);
                const logTypeName = getLogTypeName(log.log_type);
                
                return `
                    <div class="log-entry mb-3 border rounded p-3 shadow-sm bg-white">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <span class="badge ${logTypeClass} me-2">${logTypeName}</span>
                                <small class="text-primary fw-bold">#${String(index + 1).padStart(3, '0')}</small>
                </div>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>${logTime}
                            </small>
                        </div>
                        <div class="log-content">
                            <div class="mb-2">
                                <strong class="text-dark">${log.action || log.optimization_type || '策略操作'}</strong>
                            </div>
                            ${log.trigger_reason ? `
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-lightning me-1"></i>
                                        <strong>触发原因:</strong> ${log.trigger_reason}
                                    </small>
                                </div>
                            ` : ''}
                            ${log.details ? `
                                <div class="mb-2">
                                    <small class="text-secondary">
                                        <i class="fas fa-info-circle me-1"></i>
                                        ${log.details}
                                    </small>
                                </div>
                            ` : ''}
                            ${log.pnl ? `
                                <div class="mt-2">
                                    <span class="badge ${log.pnl >= 0 ? 'bg-success' : 'bg-danger'} fs-6">
                                        <i class="fas fa-dollar-sign me-1"></i>
                                        PnL: ${log.pnl} USDT
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="tab-pane fade${activeClass}" id="${tabId}" role="tabpanel">
                    <div class="logs-container" style="max-height: 500px; overflow-y: auto; padding: 10px;">
                        ${logsHtml}
                    </div>
                </div>
            `;
        }
        
        // 获取日志类型名称
        function getLogTypeName(type) {
            const names = {
                'all': '全部日志',
                'evolution': '进化日志',
                'validation': '验证交易',
                'trading': '验证交易',
                'real_trading': '真实交易'
            };
            return names[type] || type;
        }
        
        // 获取日志类型样式类
        function getLogTypeClass(type) {
            const classes = {
                'evolution': 'bg-primary',
                'validation': 'bg-info',
                'trading': 'bg-info',
                'real_trading': 'bg-success'
            };
            return classes[type] || 'bg-secondary';
        }
        
        // 显示所有日志函数
        function showAllLogs() {
            console.log('显示所有日志');
            
            // 显示日志模态框
            const modal = new bootstrap.Modal(document.getElementById('logsModal'));
                modal.show();
            
            // 立即加载所有日志数据
            loadAllLogsData();
        }
        
        // 加载所有日志数据
        function loadAllLogsData() {
            const container = document.getElementById('logsContent');
            if (!container) return;
            
            // 显示加载状态
            container.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">正在加载系统日志...</p>
                </div>
            `;
            
            // 模拟加载一些日志数据（您可以替换为真实的API调用）
            setTimeout(() => {
                const sampleLogs = [
                    {
                        timestamp: new Date().toISOString(),
                        type: 'system',
                        message: '系统启动完成',
                        level: 'info'
                    },
                    {
                        timestamp: new Date(Date.now() - 300000).toISOString(),
                        type: 'strategy',
                        message: '策略进化系统启动',
                        level: 'info'
                    },
                    {
                        timestamp: new Date(Date.now() - 600000).toISOString(),
                        type: 'trading',
                        message: '验证交易执行完成',
                        level: 'success'
                    }
                ];
                
                displayAllLogs(sampleLogs);
            }, 1000);
        }
        
        // 显示所有日志
        function displayAllLogs(logs) {
            const container = document.getElementById('logsContent');
            if (!container) return;
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                        <p>暂无系统日志</p>
                    </div>
                `;
                return;
            }
            
            const logsHtml = logs.map(log => {
                const logTime = new Date(log.timestamp).toLocaleString();
                const levelClass = {
                    'info': 'text-info',
                    'success': 'text-success',
                    'warning': 'text-warning',
                    'error': 'text-danger'
                }[log.level] || 'text-muted';
                
                return `
                    <div class="log-entry border-bottom py-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge bg-secondary me-2">${log.type}</span>
                                <span class="${levelClass}">${log.message}</span>
                            </div>
                            <small class="text-muted">${logTime}</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div style="max-height: 500px; overflow-y: auto;">
                    ${logsHtml}
                </div>
            `;
        }
        
        // 应用日志筛选
        function applyLogFilters() {
            console.log('应用日志筛选');
            const logType = document.getElementById('logTypeFilter')?.value || 'all';
            const strategy = document.getElementById('strategyFilter')?.value || '';
            const date = document.getElementById('dateFilter')?.value || '';
            
            // 重新加载日志数据（这里可以添加筛选参数）
            loadAllLogsData();
        }
        
        // 导出日志
        function exportLogs() {
            console.log('导出日志');
            // 创建一个简单的导出功能
            const logEntries = document.querySelectorAll('.log-entry');
            if (logEntries.length === 0) {
                alert('没有日志数据可导出');
                return;
            }
            
            let csvContent = "时间,类型,消息\n";
            logEntries.forEach(entry => {
                const timeElement = entry.querySelector('.text-muted');
                const typeElement = entry.querySelector('.badge');
                const messageElement = entry.querySelector('span:not(.badge)');
                
                if (timeElement && typeElement && messageElement) {
                    const time = timeElement.textContent.trim();
                    const type = typeElement.textContent.trim();
                    const message = messageElement.textContent.trim().replace(/"/g, '""');
                    csvContent += `"${time}","${type}","${message}"\n`;
                }
            });
            
            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `策略日志_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 添加缺失的按钮功能
        function showStrategyManagement() {
            console.log('打开策略管理配置页面');
            
            // 🔧 加载配置数据并记录旧值
            loadManagementConfigData().then(() => {
                // 显示弹窗
                const modal = new bootstrap.Modal(document.getElementById('strategyManagementModal'));
                modal.show();
                
                // 🔧 记录关键配置的初始值，用于判断是否需要重新加载
                const displayCountInput = document.getElementById('display_strategies_count');
                const realTradingCountInput = document.getElementById('real_trading_count');
                
                if (displayCountInput) {
                    displayCountInput.dataset.oldValue = displayCountInput.value;
                    console.log('🔧 记录display_strategies_count旧值:', displayCountInput.value);
                }
                
                if (realTradingCountInput) {
                    realTradingCountInput.dataset.oldValue = realTradingCountInput.value;
                    console.log('🔧 记录real_trading_count旧值:', realTradingCountInput.value);
                }
            });
        }
        
        // 🔥 新增：加载策略管理配置数据 - 修复数据格式处理
        function loadManagementConfigData() {
            return fetch('/api/quantitative/management-config')
                .then(response => response.json())
                .then(data => {
                    console.log('📊 加载到的管理配置数据:', data);
                    
                    if (data.success || data.status === 'success') {
                        const config = data.config || {};
                        const fourTierConfig = data.four_tier_config || {};
                        
                        // 🔧 填充传统配置
                        Object.entries(config).forEach(([key, value]) => {
                            const element = document.getElementById(key);
                            if (element) {
                                if (element.type === 'checkbox') {
                                    element.checked = value === true;
                } else {
                                    element.value = value;
                                }
                                console.log(`设置传统配置 ${key}:`, value);
                            }
                        });
                        
                        // 🔧 修复：处理四层进化配置的嵌套结构
                        Object.entries(fourTierConfig).forEach(([key, configData]) => {
                            const element = document.getElementById(key);
                            if (element) {
                                // 后端返回的是 {value: xxx, description: xxx, category: xxx} 格式
                                const value = configData.value !== undefined ? configData.value : configData;
                                
                                if (element.type === 'checkbox') {
                                    element.checked = value === true || value === 'true';
                } else {
                                    element.value = value;
                                }
                                console.log(`设置四层配置 ${key}:`, value);
                            }
                        });
                        
                        // 🔧 更新状态显示
                        updateSystemStatusDisplay(data);
                        
                    } else {
                        console.error('加载管理配置失败:', data.message);
                        alert('加载配置失败，将使用默认值');
                        setDefaultManagementConfig();
                    }
                })
                .catch(error => {
                    console.error('获取管理配置失败:', error);
                    alert('获取配置失败，将使用默认值');
                    setDefaultManagementConfig();
                });
        }
        
        // 🔧 设置默认管理配置
        function setDefaultManagementConfig() {
            const defaultConfigs = {
                'high_freq_pool_size': 1000,
                'display_strategies_count': 4,  // 🔧 从21改为4，匹配用户测试结果
                'real_trading_count': 3,
                'low_freq_interval_hours': 24,
                'high_freq_interval_minutes': 60,
                'display_interval_minutes': 3,
                'minScore': 10,
                'eliminationDays': 7,
                'unified_validation_count': 3,
                'validation_score_threshold_high': 80,
                'validation_score_threshold_mid': 60,
                'validation_amount': 50,
                'real_trading_amount': 200,
                'real_trading_score_threshold': 70,
                'real_trading_enabled': 'false',
                'min_simulation_days': 7,
                'min_sim_win_rate': 60,
                'min_sim_total_pnl': 10
            };
            
            Object.entries(defaultConfigs).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value === 'true';
                    } else {
                        element.value = value;
                    }
                }
            });
        }
        
        // 🔧 更新系统状态显示 - 修复数据格式处理
        function updateSystemStatusDisplay(data) {
            console.log('🔧 更新系统状态显示，输入数据:', data);
            
            const config = data.config || {};
            const fourTierConfig = data.four_tier_config || {};
            
            // 更新四层系统状态显示
            if (fourTierConfig && Object.keys(fourTierConfig).length > 0) {
                const tier1Count = document.getElementById('tier1_count');
                const tier2Count = document.getElementById('tier2_count');
                const tier3Count = document.getElementById('tier3_count');
                const tier4Count = document.getElementById('tier4_count');
                
                // 从fourTierConfig中提取值（处理嵌套结构）
                const getConfigValue = (key) => {
                    const configData = fourTierConfig[key];
                    return configData ? (configData.value !== undefined ? configData.value : configData) : null;
                };
                
                if (tier1Count) tier1Count.textContent = data.total_strategies || '1000+';
                if (tier2Count) tier2Count.textContent = getConfigValue('high_freq_pool_size') || '2000';
                if (tier3Count) tier3Count.textContent = getConfigValue('display_strategies_count') || '21';
                if (tier4Count) tier4Count.textContent = getConfigValue('real_trading_count') || '3';
                
                // 更新理论进化频率
                const lowFreqHours = getConfigValue('low_freq_interval_hours') || 24;
                const highFreqMinutes = getConfigValue('high_freq_interval_minutes') || 60;
                const displayMinutes = getConfigValue('display_interval_minutes') || 3;
                
                const tier1Evolutions = document.getElementById('tier1_evolutions');
                const tier2Evolutions = document.getElementById('tier2_evolutions');
                const tier3Evolutions = document.getElementById('tier3_evolutions');
                
                if (tier1Evolutions) tier1Evolutions.textContent = Math.round(60 / lowFreqHours * 10) / 10;
                if (tier2Evolutions) tier2Evolutions.textContent = Math.round(60 / (highFreqMinutes / 60) * 10) / 10;
                if (tier3Evolutions) tier3Evolutions.textContent = Math.round(60 / (displayMinutes / 60) * 10) / 10;
                
                // 更新评分门槛
                const tier4Threshold = document.getElementById('tier4_threshold');
                if (tier4Threshold) tier4Threshold.textContent = getConfigValue('real_trading_score_threshold') || '70';
                
                console.log('✅ 四层系统状态已更新');
            }
            
            // 更新策略数量统计（这些数据通常不在配置API中，需要另外获取）
            const currentActive = document.getElementById('currentActiveStrategies');
            const realTradingCount = document.getElementById('realTradingStrategiesCount');
            const validationCount = document.getElementById('validationStrategiesCount');
            const totalCount = document.getElementById('totalStrategiesCount');
            
            if (currentActive) currentActive.textContent = data.active_strategies || '-';
            if (realTradingCount) realTradingCount.textContent = data.real_trading_strategies || '-';
            if (validationCount) validationCount.textContent = data.validation_strategies || '-';
            if (totalCount) totalCount.textContent = data.total_strategies || '-';
            
            console.log('✅ 系统状态显示更新完成');
        }
        
        function toggleSystem() {
            console.log('切换量化系统状态');
            const toggle = document.getElementById('systemToggle');
            if (toggle) {
                toggle.classList.toggle('active');
            }
        }
        
        function toggleAutoTrading() {
            console.log('切换自动交易状态');
            const toggle = document.getElementById('autoTradingToggle');
            if (toggle) {
                toggle.classList.toggle('active');
            }
        }
        
        function toggleBalanceChart(period) {
            console.log('切换资产图表周期:', period);
            // 更新按钮状态
            document.querySelectorAll('[onclick*="toggleBalanceChart"]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 重新加载资产图表数据
            loadBalanceChartData(period);
        }
        
        // 加载底部四个模块的数据 - 优化并发控制
        function loadBottomModulesData() {
            console.log('🔄 加载底部四个模块数据...');
            
            // 🔧 防止重复加载
            if (window.bottomModulesLoading) {
                console.log('⚠️ 底部模块正在加载中，跳过重复请求');
                return;
            }
            
            window.bottomModulesLoading = true;
            
            try {
                // 🔧 错开加载时间，避免同时发送多个请求
                
                // 1. 加载收益曲线数据
                const timer1 = GlobalTimerManager.addTimer(setTimeout(() => {
                    loadPerformanceChartData();
                    GlobalTimerManager.clearTimer(timer1);
                }, 500));
                
                // 2. 加载资产增长数据  
                const timer2 = GlobalTimerManager.addTimer(setTimeout(() => {
                    loadBalanceChartData('30');
                    GlobalTimerManager.clearTimer(timer2);
                }, 1000));
                
                // 3. 加载最新信号数据
                const timer3 = GlobalTimerManager.addTimer(setTimeout(() => {
                    loadLatestSignalsData();
                    GlobalTimerManager.clearTimer(timer3);
                }, 1500));
                
                // 4. 加载持仓数据
                const timer4 = GlobalTimerManager.addTimer(setTimeout(() => {
                    loadPositionsData();
                    GlobalTimerManager.clearTimer(timer4);
                    
                    // 🔧 所有模块加载完成
                    setTimeout(() => {
                        window.bottomModulesLoading = false;
                        console.log('✅ 底部四个模块数据加载完成');
                    }, 1000);
                }, 2000));
                
            } catch (error) {
                console.error('❌ 底部模块数据加载失败:', error);
                window.bottomModulesLoading = false;
            }
        }
        
        // 加载收益曲线数据
        function loadPerformanceChartData() {
            const placeholder = document.getElementById('performanceChartPlaceholder');
            if (!placeholder) return;
            
            // 模拟收益数据
            setTimeout(() => {
                const sampleData = [
                    { date: '07-01', value: 2.5 },
                    { date: '07-02', value: 3.1 },
                    { date: '07-03', value: 2.8 },
                    { date: '07-04', value: 4.2 },
                    { date: '07-05', value: 3.9 }
                ];
                
                placeholder.innerHTML = `
                    <div class="performance-data">
                        ${sampleData.map(item => `
                            <div class="data-row d-flex justify-content-between py-1">
                                <small class="text-muted">${item.date}</small>
                                <small class="fw-bold ${item.value >= 0 ? 'text-success' : 'text-danger'}">+${item.value}%</small>
                            </div>
                        `).join('')}
                    </div>
                `;
            }, 1000);
        }
        
        // 加载资产增长数据
        function loadBalanceChartData(period = '30') {
            const placeholder = document.getElementById('balanceChartPlaceholder');
            if (!placeholder) return;
            
            // 更新当前余额
            const currentBalance = document.getElementById('currentBalance2');
            if (currentBalance) {
                currentBalance.textContent = '12.3U';
                currentBalance.className = 'milestone-value text-success small';
            }
            
            setTimeout(() => {
                placeholder.innerHTML = `
                    <div class="balance-summary text-center py-3">
                        <div class="balance-change">
                            <span class="h5 text-success">+23%</span>
                            <br>
                            <small class="text-muted">过去${period}天增长</small>
                        </div>
                    </div>
                `;
            }, 800);
        }
        
        // 加载最新信号数据
        function loadLatestSignalsData() {
            const container = document.getElementById('signalsContainer2');
            if (!container) return;
            
            setTimeout(() => {
                const sampleSignals = [
                    { time: '09:15', symbol: 'BTC/USDT', action: 'BUY', price: '43,250', strategy: 'adc826f4' },
                    { time: '09:12', symbol: 'ETH/USDT', action: 'SELL', price: '2,680', strategy: 'a804ec55' },
                    { time: '09:08', symbol: 'BTC/USDT', action: 'BUY', price: '43,180', strategy: 'cf6b57ea' }
                ];
                
                container.innerHTML = sampleSignals.map((signal, index) => `
                    <div class="signal-item mb-2 p-3 rounded border bg-light">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge ${signal.action === 'BUY' ? 'bg-success' : 'bg-danger'} me-2 px-2 py-1">${signal.action}</span>
                                    <strong class="text-dark">${signal.symbol}</strong>
                                </div>
                                <div class="signal-details">
                                    <small class="text-muted d-block">
                                        <i class="fas fa-dollar-sign me-1"></i>
                                        价格: $${signal.price}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-robot me-1"></i>
                                        策略${signal.strategy.slice(-4)}
                                    </small>
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-primary fw-bold">${signal.time}</small>
                            </div>
                        </div>
                    </div>
                `).join('');
            }, 1200);
        }
        
        // 加载持仓数据
        function loadPositionsData() {
            const container = document.getElementById('positionsContainer');
            if (!container) return;
            
            setTimeout(() => {
                const samplePositions = [
                    { symbol: 'BTC/USDT', amount: '0.0028', value: '121.5', pnl: '+2.8', pnlPercent: '+2.4%' },
                    { symbol: 'ETH/USDT', amount: '0.045', value: '120.6', pnl: '+1.2', pnlPercent: '+1.0%' },
                    { symbol: 'SOL/USDT', amount: '1.2', value: '89.4', pnl: '-0.8', pnlPercent: '-0.9%' }
                ];
                
                container.innerHTML = samplePositions.map((pos, index) => `
                    <div class="position-item mb-2 p-3 rounded border ${pos.pnl.startsWith('+') ? 'bg-success-subtle border-success-subtle' : 'bg-danger-subtle border-danger-subtle'}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <strong class="text-dark">${pos.symbol}</strong>
                                    <span class="badge bg-secondary ms-2 small">${pos.amount}</span>
                                </div>
                                <div class="position-value">
                                    <small class="text-muted">
                                        <i class="fas fa-coins me-1"></i>
                                        持仓价值: $${pos.value}
                                    </small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="pnl-container">
                                    <div class="fw-bold ${pos.pnl.startsWith('+') ? 'text-success' : 'text-danger'}">${pos.pnl} USDT</div>
                                    <small class="${pos.pnl.startsWith('+') ? 'text-success' : 'text-danger'}">${pos.pnlPercent}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }, 1500);
        }
        
        // 策略参数保存逻辑
        function saveStrategyConfig() {
            const strategyId = document.getElementById('strategyId')?.value;
            if (!strategyId) {
                alert('策略ID不能为空');
                return;
            }
            
            // 收集表单数据
            const formData = {
                name: document.getElementById('strategyName')?.value,
                symbol: document.getElementById('strategySymbol')?.value,
                type: document.getElementById('strategyType')?.value,
                enabled: document.getElementById('strategyEnabled')?.checked
            };
            
            // 收集策略参数
            const parameters = {};
            const paramInputs = document.querySelectorAll('#strategyParameters input[id^="param_"]');
            paramInputs.forEach(input => {
                const key = input.id.replace('param_', '');
                const value = parseFloat(input.value) || input.value;
                parameters[key] = value;
            });
            
            formData.parameters = parameters;
            
            console.log('保存策略配置:', { strategyId, formData });
            
            // 调用保存API
            fetch(`/api/quantitative/strategies/${strategyId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success || data.status === 'success') {
                    alert('策略配置保存成功！');
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('strategyConfigModal'));
                    if (modal) modal.hide();
                    // 重新加载策略列表
                    forceLoadStrategies();
                } else {
                    throw new Error(data.message || '保存失败');
                }
            })
            .catch(error => {
                console.error('保存策略配置失败:', error);
                alert(`保存失败: ${error.message}`);
            });
        }
        
        // 重置策略参数
        function resetStrategyParams() {
            const strategyId = document.getElementById('strategyId')?.value;
            if (!strategyId) return;
            
            if (confirm('确定要重置策略参数到默认值吗？')) {
                // 重新加载策略配置
                loadStrategyConfigData(strategyId);
            }
        }
        
        // 重置策略管理配置
        function resetManagementConfig() {
            if (confirm('确定要恢复策略管理配置到默认值吗？')) {
                // 重置所有表单字段到默认值
                document.getElementById('strategyManagementForm').reset();
                // 设置一些默认值
                const defaultConfigs = {
                    'high_freq_pool_size': 1000,
                    'display_strategies_count': 21,
                    'real_trading_count': 3,
                    'low_freq_interval_hours': 24,
                    'high_freq_interval_minutes': 60,
                    'display_interval_minutes': 3,
                    'minScore': 10,
                    'eliminationDays': 7,
                    'unified_validation_count': 3,
                    'validation_score_threshold_high': 80,
                    'validation_score_threshold_mid': 60,
                    'validation_amount': 50,
                    'real_trading_amount': 200,
                    'real_trading_score_threshold': 70,
                    'real_trading_enabled': 'false',
                    'min_simulation_days': 7,
                    'min_sim_win_rate': 60,
                    'min_sim_total_pnl': 10
                };
                
                Object.entries(defaultConfigs).forEach(([key, value]) => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value === 'true';
                    } else {
                            element.value = value;
                        }
                    }
                });
                
                alert('配置已恢复到默认值！');
            }
        }
        
        // 保存策略管理配置 - 优化提示和智能重新加载
        function saveManagementConfig() {
            // 显示保存中提示
            const saveBtn = event?.target;
            const originalText = saveBtn?.innerHTML;
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>保存中...';
                saveBtn.disabled = true;
            }
            
            const formData = {};
            
            // 🔧 保存前记录影响策略显示的关键配置
            const oldDisplayCount = document.getElementById('display_strategies_count')?.dataset.oldValue;
            const oldRealTradingCount = document.getElementById('real_trading_count')?.dataset.oldValue;
            
            // 收集配置表单数据
            const configInputs = document.querySelectorAll('#strategyManagementForm input, #strategyManagementForm select');
            configInputs.forEach(input => {
                let value = input.value;
                if (input.type === 'number') {
                    value = parseFloat(value) || 0;
                } else if (input.type === 'checkbox') {
                    value = input.checked;
                }
                formData[input.name || input.id] = value;
            });
            
            console.log('保存管理配置:', formData);
            
            // 显示保存提示
            showSaveMessage('正在保存配置...', 'info');
            
            // 🔧 修复：更新API数据格式以匹配后端要求
            const requestData = {
                config: formData,  // 传统配置
                four_tier_config: {}  // 四层进化配置
            };
            
            // 将四层相关配置分类到four_tier_config
            const fourTierKeys = [
                'high_freq_pool_size', 'display_strategies_count', 'real_trading_count',
                'low_freq_interval_hours', 'high_freq_interval_minutes', 'display_interval_minutes',
                'unified_validation_count', 'validation_score_threshold_high', 'validation_score_threshold_mid',
                'validation_amount', 'real_trading_amount', 'real_trading_score_threshold',
                'real_trading_enabled', 'min_simulation_days', 'min_sim_win_rate', 'min_sim_total_pnl',
                'minScore', 'eliminationDays'
            ];
            
            fourTierKeys.forEach(key => {
                if (formData[key] !== undefined) {
                    requestData.four_tier_config[key] = formData[key];
                    delete requestData.config[key];  // 从传统配置中移除
                }
            });
            
            console.log('🔧 配置数据格式:', requestData);
            
            fetch('/api/quantitative/management-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success || data.status === 'success') {
                    showSaveMessage('策略管理配置保存成功！', 'success');
                    
                    // 🔧 智能重新加载：只有在影响策略显示的配置改变时才重新加载
                    const newDisplayCount = formData.display_strategies_count;
                    const newRealTradingCount = formData.real_trading_count;
                    
                    const needReloadStrategies = (
                        oldDisplayCount && oldDisplayCount != newDisplayCount ||
                        oldRealTradingCount && oldRealTradingCount != newRealTradingCount
                    );
                    
                    if (needReloadStrategies) {
                        console.log('🔄 检测到策略显示配置改变，重新加载策略列表...');
                        setTimeout(() => {
                            forceLoadStrategies();
                            showSaveMessage('策略显示配置已更新！', 'success');
                        }, 1000);
                    } else {
                        console.log('✅ 配置保存成功，无需重新加载策略列表');
                        setTimeout(() => {
                            showSaveMessage('配置保存完成，无需重新加载！', 'success');
                        }, 1500);
                    }
                    
                } else {
                    throw new Error(data.message || '保存失败');
                }
            })
            .catch(error => {
                console.error('保存管理配置失败:', error);
                showSaveMessage(`保存失败: ${error.message}`, 'error');
            })
            .finally(() => {
                // 恢复按钮状态
                if (saveBtn && originalText) {
            setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                    }, 1000);
                }
            });
        }
        
        // 显示保存消息提示
        function showSaveMessage(message, type = 'info') {
            // 移除现有提示
            const existingAlert = document.querySelector('.save-message-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'info': 'alert-info',
                'warning': 'alert-warning'
            }[type] || 'alert-info';
            
            const icon = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-triangle', 
                'info': 'fas fa-info-circle',
                'warning': 'fas fa-exclamation-circle'
            }[type] || 'fas fa-info-circle';
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show save-message-alert" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <i class="${icon} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // 自动消失
                        setTimeout(() => {
                const alert = document.querySelector('.save-message-alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 300);
                }
                        }, 3000);
        }
        
        // 🔧 增加自动保存功能 - 添加防抖机制
        function enableAutoSave() {
            const inputs = document.querySelectorAll('#strategyManagementForm input, #strategyManagementForm select');
            
            // 🔧 防抖：避免频繁保存
            let debounceTimer = null;
            const DEBOUNCE_DELAY = 3000; // 3秒防抖延迟
            
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    console.log('🔧 配置项发生变化，准备自动保存...');
                    
                    // 清除之前的定时器
                    if (debounceTimer) {
                        clearTimeout(debounceTimer);
                    }
                    
                    // 🔧 设置新的防抖定时器，避免频繁请求
                    debounceTimer = setTimeout(() => {
                        console.log('🔄 执行自动保存...');
                        saveManagementConfig();
                    }, DEBOUNCE_DELAY);
                });
            });
            
            // 🔧 页面卸载时清理定时器
            window.addEventListener('beforeunload', function() {
                if (debounceTimer) {
                    clearTimeout(debounceTimer);
                    debounceTimer = null;
                }
            });
        }
        
        // 暴露必要的全局函数
        window.forceLoadStrategies = forceLoadStrategies;
        window.refreshStrategies = refreshStrategies;
        // 🗑️ displayStrategies已删除，使用quantitativeSystem.renderStrategies()
        window.configStrategy = configStrategy;
        window.showStrategyLogs = showStrategyLogs;
        window.showAllLogs = showAllLogs;
        window.loadStrategyLogData = loadStrategyLogData;
        window.loadStrategyConfigData = loadStrategyConfigData;
        window.applyLogFilters = applyLogFilters;
        window.exportLogs = exportLogs;
        window.toggleBalanceChart = toggleBalanceChart;
        window.loadBottomModulesData = loadBottomModulesData;
        window.loadPerformanceChartData = loadPerformanceChartData;
        window.loadBalanceChartData = loadBalanceChartData;
        window.loadLatestSignalsData = loadLatestSignalsData;
        window.loadPositionsData = loadPositionsData;
        window.showStrategyManagement = showStrategyManagement;
        window.toggleSystem = toggleSystem;
        window.toggleAutoTrading = toggleAutoTrading;
        window.saveStrategyConfig = saveStrategyConfig;
        window.resetStrategyParams = resetStrategyParams;
        window.saveManagementConfig = saveManagementConfig;
        window.resetManagementConfig = resetManagementConfig;
        
        // 🔧 全局定时器清理机制
        const GlobalTimerManager = {
            timers: new Set(),
            
            addTimer: function(timerId) {
                this.timers.add(timerId);
                return timerId;
            },
            
            clearTimer: function(timerId) {
                if (timerId) {
                    clearTimeout(timerId);
                    this.timers.delete(timerId);
                }
            },
            
            clearAllTimers: function() {
                console.log('🧹 清理所有定时器，共计:', this.timers.size);
                this.timers.forEach(timerId => {
                    clearTimeout(timerId);
                });
                this.timers.clear();
            }
        };
        
        // 页面卸载时清理所有定时器
        window.addEventListener('beforeunload', function() {
            GlobalTimerManager.clearAllTimers();
            console.log('✅ 页面卸载，已清理所有定时器');
        });
        
        // 页面隐藏时也清理定时器（移动端兼容）
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                GlobalTimerManager.clearAllTimers();
                console.log('✅ 页面隐藏，已清理所有定时器');
            }
        });
        
        // 暴露定时器管理器到全局
        window.GlobalTimerManager = GlobalTimerManager;
    </script>

    <!-- 🎨 页面美化样式增强 -->
    <style>
        /* 🌈 整体背景美化 */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            background-attachment: fixed;
            min-height: 100vh;
        }
        
        /* 📦 容器美化 */
        .container-fluid {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        /* 🎯 卡片增强效果 */
        .card {
            border: none !important;
            border-radius: 15px !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px) !important;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15) !important;
        }
        
        /* 🎨 渐变色标题美化 - 修复可读性 */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%) !important;
            color: white !important;
        }
        
        .bg-gradient-success {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important;
            color: white !important;
        }
        
        .bg-gradient-info {
            background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%) !important;
            color: white !important;
        }
        
        .bg-gradient-warning {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%) !important;
            color: white !important;
        }
        
        /* 📊 策略卡片样式增强 - 提高对比度 */
        .strategy-card {
            background: white !important;
            border-radius: 12px !important;
            border: 2px solid rgba(79, 70, 229, 0.1) !important;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08) !important;
        }
        
        .strategy-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.15) !important;
            border-color: rgba(79, 70, 229, 0.3) !important;
        }
        
        /* 🎯 里程碑卡片文字优化 */
        .milestone-value {
            color: #1f2937 !important;
            font-weight: 700 !important;
            font-size: 1.1rem !important;
        }
        
        .milestone-label {
            color: #6b7280 !important;
            font-weight: 500 !important;
        }
        
        /* 📋 信号和持仓卡片内容优化 */
        .signal-item, .position-item {
            background: #f8fafc !important;
            border: 1px solid #e2e8f0 !important;
            color: #1f2937 !important;
        }
        
        .signal-item .badge, .position-item .badge {
            font-weight: 600 !important;
        }
        
        /* 🌟 加载状态文字优化 */
        .loading-content {
            color: #4b5563 !important;
        }
        
        .text-muted {
            color: #6b7280 !important;
        }
        
        /* 📊 数据行文字优化 */
        .data-row {
            color: #374151 !important;
        }
        
        .data-row .text-success {
            color: #059669 !important;
            font-weight: 600 !important;
        }
        
        .data-row .text-danger {
            color: #dc2626 !important;
            font-weight: 600 !important;
        }
        
        /* 🔄 加载动画优化 */
        .loading-content {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* 🎯 按钮样式增强 */
        .btn {
            border-radius: 8px !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        /* 📈 状态徽章美化 */
        .badge {
            font-size: 0.75rem !important;
            font-weight: 600 !important;
            padding: 0.4rem 0.8rem !important;
            border-radius: 20px !important;
        }
        
        /* 🎨 模态框美化 */
        .modal-content {
            border: none !important;
            border-radius: 15px !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2) !important;
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.08) !important;
            border-radius: 15px 15px 0 0 !important;
        }
        
        /* 📊 配置表单样式 */
        .form-control, .form-select {
            border-radius: 8px !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
        }
        
        /* 🌈 成功提示美化 */
        .save-message-alert {
            border: none !important;
            border-radius: 12px !important;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
    </style>
</body>
</html> 