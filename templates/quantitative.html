<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校长的量化系统 - 量化交易</title>
    <!-- 添加favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <!-- 替换为更稳定的CDN -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- 引用量化交易专用样式 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/quantitative.css') }}">
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg" style="background: linear-gradient(135deg, #1677ff, #4096ff);">
            <div class="container-fluid">
                <div class="navbar-content">
                    <!-- 左侧：品牌名和系统状态 -->
                    <div class="navbar-left">
                        <div class="navbar-brand-group">
                            <a class="navbar-brand" href="/">
                                <i class="fas fa-chart-line"></i>
                                校长的量化系统
                            </a>
                            <div class="system-status">
                                <span class="status-indicator status-offline" id="system-status-indicator"></span>
                                <span id="system-status-text">离线</span>
                                <span id="current-time">2025/6/4 05:05:27</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧：导航菜单 -->
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-home"></i>
                                <span class="nav-link-desktop-text">市场数据</span>
                                <span class="nav-link-mobile-text">市场</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/quantitative.html">
                                <i class="fas fa-robot"></i>
                                <span class="nav-link-desktop-text">量化交易</span>
                                <span class="nav-link-mobile-text">量化</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/arbitrage.html">
                                <i class="fas fa-exchange-alt"></i>
                                <span class="nav-link-desktop-text">套利系统</span>
                                <span class="nav-link-mobile-text">套利</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/operations-log.html">
                                <i class="fas fa-list-alt"></i>
                                <span class="nav-link-desktop-text">操作日志</span>
                                <span class="nav-link-mobile-text">日志</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container-fluid mt-4">
        <!-- 系统状态栏 -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card border-0 shadow-sm bg-gradient">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <!-- 🔥 统一全局状态指示器 -->
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator me-2" id="globalStatusIndicator">
                                        <span class="status-dot bg-secondary"></span>
                                    </div>
                                    <div>
                                        <small class="text-muted">系统状态</small>
                                        <div class="fw-bold" id="globalSystemStatus">检查中...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 实时数据连接状态 -->
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator me-2" id="websocketStatusIndicator">
                                        <span class="status-dot bg-warning"></span>
                                    </div>
                                    <div>
                                        <small class="text-muted">实时连接</small>
                                        <div class="fw-bold" id="websocketStatus">连接中...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 交易所连接状态 -->
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator me-2" id="exchangeStatusIndicator">
                                        <span class="status-dot bg-info"></span>
                                    </div>
                                    <div>
                                        <small class="text-muted">交易所API</small>
                                        <div class="fw-bold" id="exchangeStatus">检查中...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 策略进化状态 -->
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="status-indicator me-2" id="evolutionStatusIndicator">
                                        <span class="status-dot bg-primary"></span>
                                    </div>
                                    <div>
                                        <small class="text-muted">策略进化</small>
                                        <div class="fw-bold" id="evolutionStatus">运行中...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 优化后的策略进化滚动日志 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>策略进化实时监控
                        </h6>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-light text-primary me-2" id="evolutionLogCount">0 条记录</span>
                            <button class="btn btn-sm btn-outline-light" onclick="showAllLogs()">
                                <i class="fas fa-list me-1"></i>查看全部
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- 增强的滚动日志显示 -->
                        <div class="evolution-ticker-container" style="height: 120px; overflow: hidden; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                            <div class="evolution-ticker" id="evolutionTicker">
                                <div class="ticker-item">
                                    <span class="text-muted">正在加载策略进化日志...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 顶部控制面板 -->
        <div class="row mb-4">
            <!-- 系统控制台 -->
            <div class="col-md-4 mb-3">
                <div class="card system-control-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-cog"></i> 系统控制台
                        </h5>
                        
                        <!-- 系统状态 -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>系统状态</span>
                                <span id="systemStatus">
                                    <span class="status-indicator status-offline"></span>
                                    离线
                                </span>
                            </div>
                        </div>
                        
                        <!-- 系统启停控制 -->
                        <div class="mb-3" data-system="quantitative">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>量化系统</span>
                                <button id="systemToggle" class="btn-toggle" onclick="toggleSystem()">
                                </button>
                            </div>
                        </div>
                        
                        <!-- 自动交易开关 -->
                        <div class="mb-3" data-system="auto-trading">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>真实交易</span>
                                <button id="autoTradingToggle" class="btn-toggle" onclick="toggleAutoTrading()">
                                </button>
                            </div>
                        </div>
                        
                        <!-- 策略管理 -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>策略管理</span>
                                <button class="btn btn-sm btn-outline-light" onclick="showStrategyManagement()">
                                    <i class="fas fa-cogs"></i> 配置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 账户总览 -->
            <div class="col-md-4 mb-3">
                <div class="card account-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-wallet"></i> 账户总览
                        </h5>
                        
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="metric-value" id="totalBalance">-</div>
                                <div class="metric-label">总资产</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value text-success" id="dailyPnl">-</div>
                                <div class="metric-label">今日盈亏</div>
                            </div>
                        </div>
                        
                        <hr style="border-color: rgba(255,255,255,0.3);">
                        
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="metric-value" id="dailyReturn">-</div>
                                <div class="metric-label">今日收益率</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value" id="dailyTrades">-</div>
                                <div class="metric-label">今日交易</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 交易所状态 -->
            <div class="col-md-4 mb-3">
                <div class="card exchange-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-link"></i> 交易所状态
                        </h5>
                        
                        <div id="exchangeStatus">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>
                                    <span class="status-indicator status-online"></span>
                                    币安 (Binance)
                                </span>
                                <small>25ms</small>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>API权限</span>
                                <span class="badge bg-success">现货交易</span>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <span>最后更新</span>
                                <small id="lastUpdate">刚刚</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 策略管理 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-brain"></i> 量化策略管理
                        </h5>
                        <div class="d-flex align-items-center">
                            <!-- 策略进化滚动日志 -->
                            <div class="evolution-log-container me-3">
                                <div class="evolution-log-header">
                                    <i class="fas fa-chart-line text-primary me-1"></i>
                                    <small class="text-muted">策略进化日志</small>
                                </div>
                                <div class="evolution-log-content" id="evolutionLog">
                                    <div class="evolution-log-ticker" id="evolutionTicker">
                                        <!-- 滚动日志内容将通过JavaScript动态加载 -->
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-info btn-sm" onclick="showAllLogs()" title="查看全部日志">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" id="strategiesContainer">
                            <!-- 策略卡片将通过JavaScript动态生成 -->
                            <div class="col-12">
                                <div class="alert alert-warning" id="jsTestStatus">
                                    🔧 正在测试JavaScript执行...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 实时监控 -->
        <div class="row mb-4">
            <!-- 持仓监控 -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-coins"></i> 当前持仓
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>交易对</th>
                                        <th>数量</th>
                                        <th>均价</th>
                                        <th>浮盈</th>
                                    </tr>
                                </thead>
                                <tbody id="positionsTable">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">暂无持仓</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 交易信号 -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-signal"></i> 最新信号
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>交易对</th>
                                        <th>信号</th>
                                        <th>置信度</th>
                                    </tr>
                                </thead>
                                <tbody id="signalsTable">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">暂无信号</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 收益曲线图 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line"></i> 收益曲线
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="performance-chart">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-area"></i> 资产增长历程
                        </h6>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="app.toggleBalanceChart('30')">30天</button>
                            <button class="btn btn-sm btn-outline-primary active" onclick="app.toggleBalanceChart('90')">90天</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="app.toggleBalanceChart('365')">1年</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="balance-chart">
                            <canvas id="balanceChart"></canvas>
                        </div>
                        
                        <!-- 里程碑展示 -->
                        <div class="milestones mt-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="milestone-item">
                                        <div class="milestone-value text-success">10U</div>
                                        <div class="milestone-label">起始资金</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="milestone-item">
                                        <div class="milestone-value text-warning" id="currentBalance">9.7U</div>
                                        <div class="milestone-label">当前资产</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="milestone-item">
                                        <div class="milestone-value text-primary">100,000U</div>
                                        <div class="milestone-label">目标资产</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 策略配置弹窗模态框 -->
    <div class="modal fade" id="strategyConfigModal" tabindex="-1" aria-labelledby="strategyConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="strategyConfigModalLabel">
                        <i class="fas fa-cog"></i> 策略配置
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="strategyConfigForm">
                        <input type="hidden" id="strategyId" name="strategyId">
                        
                        <!-- 基本信息 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="strategyName" class="form-label">策略名称</label>
                                <input type="text" class="form-control" id="strategyName" name="strategyName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="strategySymbol" class="form-label">交易对</label>
                                <select class="form-select" id="strategySymbol" name="strategySymbol" required>
                                    <option value="BTC/USDT">BTC/USDT</option>
                                    <option value="ETH/USDT">ETH/USDT</option>
                                    <option value="ADA/USDT">ADA/USDT</option>
                                    <option value="SOL/USDT">SOL/USDT</option>
                                    <option value="DOGE/USDT">DOGE/USDT</option>
                                    <option value="XRP/USDT">XRP/USDT</option>
                                </select>
                            </div>
                        </div>

                        <!-- 策略类型 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="strategyType" class="form-label">策略类型</label>
                                <select class="form-select" id="strategyType" name="strategyType" disabled>
                                    <option value="momentum">动量策略</option>
                                    <option value="mean_reversion">均值回归</option>
                                    <option value="breakout">突破策略</option>
                                    <option value="grid_trading">网格交易</option>
                                    <option value="high_frequency">高频交易</option>
                                    <option value="trend_following">趋势跟踪</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="strategyEnabled" class="form-label">策略状态</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" role="switch" id="strategyEnabled" name="strategyEnabled">
                                    <label class="form-check-label" for="strategyEnabled">启用策略</label>
                                </div>
                            </div>
                        </div>

                        <!-- 策略参数 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">策略参数</h6>
                            </div>
                            <div class="card-body">
                                <div id="strategyParameters">
                                    <!-- 动态参数表单将在这里生成 -->
                                </div>
                            </div>
                        </div>

                        <!-- 策略统计 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">策略统计</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h5 mb-1" id="strategyTotalReturn">-</div>
                                            <small class="text-muted">总收益率</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h5 mb-1" id="strategyWinRate">-</div>
                                            <small class="text-muted">成功率</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h5 mb-1" id="strategyTotalTrades">-</div>
                                            <small class="text-muted">交易次数</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h5 mb-1" id="strategyDailyReturn">-</div>
                                            <small class="text-muted">日收益率</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveStrategyConfig">保存配置</button>
                    <button type="button" class="btn btn-warning" id="resetStrategyParams">重置参数</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 策略日志弹窗 -->
    <div class="modal fade" id="strategyLogsModal" tabindex="-1" aria-labelledby="strategyLogsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="strategyLogsModalLabel">
                        <i class="fas fa-history"></i> 策略日志
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 日志类型选择 -->
                    <ul class="nav nav-tabs mb-3" id="logsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="trade-logs-tab" data-bs-toggle="tab" data-bs-target="#trade-logs" type="button" role="tab">
                                <i class="fas fa-exchange-alt"></i> 交易日志
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="optimization-logs-tab" data-bs-toggle="tab" data-bs-target="#optimization-logs" type="button" role="tab">
                                <i class="fas fa-wrench"></i> 优化记录
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="logsTabContent">
                        <!-- 交易日志 -->
                        <div class="tab-pane fade show active" id="trade-logs" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>时间</th>
                                            <th>信号</th>
                                            <th>价格</th>
                                            <th>数量</th>
                                            <th>置信度</th>
                                            <th>交易类型</th>
                                            <th>执行状态</th>
                                            <th>盈亏</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tradeLogsTable">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">暂无交易记录</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- 交易日志分页控件 -->
                            <div id="tradeLogPaginationContainer" class="mt-3">
                                <!-- 分页按钮将在这里动态生成 -->
                            </div>
                        </div>

                        <!-- 优化记录 -->
                        <div class="tab-pane fade" id="optimization-logs" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>时间</th>
                                            <th>优化类型</th>
                                            <th>修改前参数</th>
                                            <th>修改后参数</th>
                                            <th>触发原因</th>
                                            <th>目标成功率</th>
                                        </tr>
                                    </thead>
                                    <tbody id="optimizationLogsTable">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">暂无优化记录</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- 分页控件 -->
                            <div id="logPaginationContainer" class="mt-3">
                                <!-- 分页按钮将在这里动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-info" id="exportLogs">导出日志</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 策略管理配置弹窗 -->
    <div class="modal fade" id="strategyManagementModal" tabindex="-1" aria-labelledby="strategyManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="strategyManagementModalLabel">
                        <i class="fas fa-cogs"></i> 策略管理配置
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="strategyManagementForm">
                        <!-- 全自动策略管理 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-robot"></i> 全自动策略管理
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <strong>启用全自动策略管理</strong>
                                        <p class="text-muted mb-0 small">自动选择、启用、轮换和优化策略，实现全自动量化交易</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="autoManagementEnabled">
                                        <label class="form-check-label" for="autoManagementEnabled">
                                            <span id="autoManagementStatus" class="text-muted">禁用</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="autoManagementConfig" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="minActiveStrategies" class="form-label">最少活跃策略数</label>
                                            <input type="number" class="form-control" id="minActiveStrategies" value="2" min="1" max="10">
                                            <div class="form-text">系统自动保持的最少运行策略数量</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="maxActiveStrategies" class="form-label">最多活跃策略数</label>
                                            <input type="number" class="form-control" id="maxActiveStrategies" value="5" min="2" max="20">
                                            <div class="form-text">系统同时运行的最多策略数量</div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="autoEnableThreshold" class="form-label">自动启用门槛</label>
                                            <input type="number" class="form-control" id="autoEnableThreshold" value="45" min="20" max="80" step="0.1">
                                            <div class="form-text">策略达到此分值自动启用验证交易</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="autoSelectionInterval" class="form-label">选择检查间隔 (分钟)</label>
                                            <input type="number" class="form-control" id="autoSelectionInterval" value="10" min="5" max="60">
                                            <div class="form-text">自动检查和选择策略的间隔时间</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="strategyRotationEnabled" checked>
                                            <label class="form-check-label" for="strategyRotationEnabled">
                                                启用策略轮换机制
                                            </label>
                                        </div>
                                        <div class="form-text">自动替换表现不佳的策略为更优秀的策略</div>
                                    </div>
                                    
                                    <!-- 实时状态显示 -->
                                    <div class="mt-4 p-3 bg-light rounded">
                                        <h6 class="mb-2">
                                            <i class="fas fa-chart-pie"></i> 当前状态
                                        </h6>
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <div class="metric-value" id="currentActiveStrategies">-</div>
                                                <div class="metric-label">活跃策略</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric-value text-success" id="realTradingStrategiesCount">-</div>
                                                <div class="metric-label">真实交易</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric-value text-info" id="validationStrategiesCount">-</div>
                                                <div class="metric-label">验证交易</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="metric-value text-muted" id="totalStrategiesCount">-</div>
                                                <div class="metric-label">总策略数</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 策略进化配置 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-dna"></i> 策略进化配置
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="evolutionInterval" class="form-label">进化更新间隔 (分钟)</label>
                                        <input type="number" class="form-control" id="evolutionInterval" value="10" min="1" max="60">
                                        <div class="form-text">策略自动进化和创建新策略的间隔时间</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="maxStrategies" class="form-label">最大策略数量</label>
                                        <input type="number" class="form-control" id="maxStrategies" value="20" min="5" max="100">
                                        <div class="form-text">系统同时运行的最大策略数量</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 策略标准配置 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-trophy"></i> 策略交易标准
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="realTradingScore" class="form-label">真实交易分值门槛</label>
                                        <input type="number" class="form-control" id="realTradingScore" value="65" min="50" max="100" step="0.1">
                                        <div class="form-text">策略达到此分值自动进行真实交易</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="realTradingCount" class="form-label">真实交易策略数量</label>
                                        <input type="number" class="form-control" id="realTradingCount" value="2" min="1" max="10">
                                        <div class="form-text">开启真实交易时选择前几名策略</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="validationAmount" class="form-label">验证交易金额 (USDT)</label>
                                        <input type="number" class="form-control" id="validationAmount" value="50" min="10" max="500" step="10">
                                        <div class="form-text">策略验证交易的单笔金额</div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="minTrades" class="form-label">最少交易次数</label>
                                        <input type="number" class="form-control" id="minTrades" value="10" min="1" max="100">
                                        <div class="form-text">策略进入真实交易的最少交易次数</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="minWinRate" class="form-label">最低胜率 (%)</label>
                                        <input type="number" class="form-control" id="minWinRate" value="65" min="50" max="95" step="0.1">
                                        <div class="form-text">策略进入真实交易的最低胜率要求</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="realTradingAmount" class="form-label">真实交易金额 (USDT)</label>
                                        <input type="number" class="form-control" id="realTradingAmount" value="100" min="50" max="1000" step="10">
                                        <div class="form-text">真实交易的单笔交易金额</div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="minProfit" class="form-label">最低收益 (USDT)</label>
                                        <input type="number" class="form-control" id="minProfit" value="0" min="0" step="0.01">
                                        <div class="form-text">策略进入真实交易的最低总收益</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="maxDrawdown" class="form-label">最大回撤 (%)</label>
                                        <input type="number" class="form-control" id="maxDrawdown" value="10" min="1" max="50" step="0.1">
                                        <div class="form-text">策略允许的最大回撤率</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="minSharpeRatio" class="form-label">最低夏普比率</label>
                                        <input type="number" class="form-control" id="minSharpeRatio" value="1.0" min="0" max="5" step="0.1">
                                        <div class="form-text">策略的最低夏普比率要求</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 风险管理配置 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-shield-alt"></i> 风险管理配置
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="maxPositionSize" class="form-label">最大仓位 (USDT)</label>
                                        <input type="number" class="form-control" id="maxPositionSize" value="100" min="10" max="10000" step="10">
                                        <div class="form-text">单个策略的最大仓位金额</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="stopLossPercent" class="form-label">止损百分比 (%)</label>
                                        <input type="number" class="form-control" id="stopLossPercent" value="5" min="1" max="20" step="0.1">
                                        <div class="form-text">全局止损触发的亏损百分比</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="takeProfitPercent" class="form-label">止盈百分比 (%)</label>
                                        <input type="number" class="form-control" id="takeProfitPercent" value="4" min="1" max="15" step="0.1">
                                        <div class="form-text">全局止盈触发的盈利百分比</div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label for="maxHoldingMinutes" class="form-label">最大持仓时间 (分钟)</label>
                                        <input type="number" class="form-control" id="maxHoldingMinutes" value="30" min="5" max="120" step="5">
                                        <div class="form-text">超过此时间且有盈利将触发时间止盈</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="minProfitForTimeStop" class="form-label">时间止盈最低收益 (%)</label>
                                        <input type="number" class="form-control" id="minProfitForTimeStop" value="1" min="0.1" max="5" step="0.1">
                                        <div class="form-text">时间止盈触发的最低收益率</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 策略淘汰配置 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-trash-alt"></i> 策略淘汰配置
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="eliminationDays" class="form-label">淘汰周期 (天)</label>
                                        <input type="number" class="form-control" id="eliminationDays" value="7" min="1" max="30">
                                        <div class="form-text">策略表现评估和淘汰的周期</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="minScore" class="form-label">最低评分</label>
                                        <input type="number" class="form-control" id="minScore" value="50" min="0" max="100" step="0.1">
                                        <div class="form-text">策略保留的最低评分标准</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" id="resetManagementConfig">恢复默认</button>
                    <button type="button" class="btn btn-primary" id="saveManagementConfig">保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 🔧 逐步测试QuantitativeSystem问题
        setTimeout(() => {
            const testEl = document.getElementById('jsTestStatus');
            if (testEl) {
                testEl.innerHTML = '✅ 基础JS正常！正在检查quantitative.js...';
                testEl.className = 'alert alert-info';
                
                // 测试文件加载
                setTimeout(() => {
                    if (typeof QuantitativeSystem === 'undefined') {
                        testEl.innerHTML = '❌ QuantitativeSystem类未定义！quantitative.js文件加载失败';
                        testEl.className = 'alert alert-danger';
                        
                        // 尝试手动加载文件进行调试
                        const script = document.createElement('script');
                        script.src = '/static/js/quantitative.js';
                        script.onload = () => {
                            testEl.innerHTML = '🔄 quantitative.js手动加载完成，重新检查...';
                            setTimeout(() => {
                                if (typeof QuantitativeSystem !== 'undefined') {
                                    testEl.innerHTML = '✅ 手动加载成功！创建实例...';
                                    try {
                                        window.app = new QuantitativeSystem();
                                        testEl.innerHTML = '🎉 成功！开始加载策略数据...';
                                        testEl.className = 'alert alert-success';
                                        window.app.loadStrategies();
                                    } catch (error) {
                                        testEl.innerHTML = `❌ 创建实例失败: ${error.message}`;
                                        testEl.className = 'alert alert-danger';
                                    }
                                } else {
                                    testEl.innerHTML = '❌ 手动加载也失败，quantitative.js有语法错误';
                                    testEl.className = 'alert alert-danger';
                                }
                            }, 1000);
                        };
                        script.onerror = () => {
                            testEl.innerHTML = '❌ quantitative.js文件无法加载，路径或权限问题';
                            testEl.className = 'alert alert-danger';
                        };
                        document.head.appendChild(script);
                    } else {
                        testEl.innerHTML = '✅ QuantitativeSystem类存在！创建实例...';
                        testEl.className = 'alert alert-success';
                        setTimeout(() => {
                            try {
                                window.app = new QuantitativeSystem();
                                testEl.innerHTML = '🎉 实例创建成功！开始加载策略数据...';
                                window.app.loadStrategies();
                            } catch (error) {
                                testEl.innerHTML = `❌ 创建实例失败: ${error.message}`;
                                testEl.className = 'alert alert-danger';
                            }
                        }, 1000);
                    }
                }, 1000);
            }
        }, 500);
    </script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script>
        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // 页面加载时立即更新时间
        updateCurrentTime();
        
        // 每秒更新时间
        setInterval(updateCurrentTime, 1000);
    </script>
    <script src="{{ url_for('static', filename='js/quantitative.js') }}"></script>
    <script>
        // 🔥 全局变量声明（必须在初始化之前，但避免重复声明）
        // systemRunning 已在 quantitative.js 中声明
        let autoTradingEnabled = false;
        let refreshTimer = null;
        let evolutionLogTimer = null;
        let managementConfig = {};
        
        // ✅ 确保app是全局变量
        window.app = null;
        var app = null; // 用于onclick事件的直接全局变量
        
        // 🔥 统一的应用初始化函数
        function initializeApp() {
            console.log('🚀 开始初始化量化交易系统...');
            
            // 检查QuantitativeSystem类是否存在
            if (typeof QuantitativeSystem === 'undefined') {
                console.error('❌ QuantitativeSystem类未定义，quantitative.js可能没有正确加载');
                return false;
            }
            
            try {
                // 🔥 创建全局app实例
                window.app = new QuantitativeSystem();
                // 🔥 同时设置为直接全局变量，兼容onclick事件
                app = window.app;
                console.log('✅ 量化交易系统实例创建成功');
                
                // 立即加载数据
                window.app.loadSystemStatus();
                window.app.loadStrategies();
                window.app.loadAccountInfo();
                window.app.loadPositions();
                window.app.loadSignals();
                
                // 绑定策略管理配置按钮事件
                bindManagementConfigEvents();
                
                return true;
            } catch (error) {
                console.error(`❌ 量化交易系统初始化失败: ${error.message}`, error);
                return false;
            }
        }
        
        // 🔥 绑定策略管理配置按钮事件
        function bindManagementConfigEvents() {
            // 策略管理配置按钮
            const managementBtn = document.querySelector('button[onclick="showStrategyManagement()"]');
            if (managementBtn) {
                managementBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showStrategyManagement();
                });
            }
            
            // 保存配置按钮
            const saveBtn = document.getElementById('saveManagementConfig');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    if (window.app) {
                        window.app.saveManagementConfig();
                    }
                });
            }
            
            // 重置配置按钮
            const resetBtn = document.getElementById('resetManagementConfig');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    if (window.app) {
                        window.app.resetManagementConfig();
                    }
                });
            }
        }
        
        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟一点确保quantitative.js完全加载
            setTimeout(() => {
                const success = initializeApp();
                
                // 在页面上显示初始化状态
                const testEl = document.getElementById('jsTestStatus');
                if (testEl) {
                    if (success) {
                        testEl.innerHTML = '🎉 应用初始化成功！系统正常运行';
                        testEl.className = 'alert alert-success';
                        // 3秒后隐藏测试信息
                        setTimeout(() => {
                            testEl.style.display = 'none';
                        }, 3000);
                    } else {
                        testEl.innerHTML = '❌ 应用初始化失败，请刷新页面重试';
                        testEl.className = 'alert alert-danger';
                    }
                }
            }, 1000);
        });
        
        // 🔥 全局函数定义 - 确保所有onclick事件都能正确工作
        window.toggleSystem = function() {
            if (window.app) {
                window.app.toggleSystem();
            } else {
                console.error('❌ app对象未初始化');
            }
        };
        
        window.toggleAutoTrading = function() {
            if (window.app) {
                window.app.toggleAutoTrading();
            } else {
                console.error('❌ app对象未初始化');
            }
        };
        
        window.refreshStrategies = function() {
            if (window.app) {
                window.app.loadStrategies();
            } else {
                console.error('❌ app对象未初始化');
            }
        };
        
        window.showStrategyManagement = function() {
            if (window.app) {
                window.app.loadManagementConfig();
                const modal = new bootstrap.Modal(document.getElementById('strategyManagementModal'));
                modal.show();
            } else {
                console.error('❌ app对象未初始化');
            }
        };
        
        window.showAllLogs = function() {
            if (window.app && window.app.allEvolutionLogs) {
                // 初始化分页变量
                window.app.logsCurrentPage = 1;
                window.app.logsPerPage = 20;
                
                // 创建全部日志模态框
                const modalHtml = `
                <div class="modal fade" id="allLogsModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title">
                <i class="fas fa-list me-2"></i>所有策略进化日志
                <span class="badge bg-primary ms-2" id="logsTotal">共 ${window.app.allEvolutionLogs.length} 条</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                <div class="table-responsive">
                <table class="table table-hover">
                <thead>
                <tr><th style="width: 20%">时间</th><th style="width: 15%">操作</th><th style="width: 65%">详情</th></tr>
                </thead>
                <tbody id="allLogsTableBody"></tbody>
                </table>
                </div>
                <!-- 分页控件 -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <span class="text-muted me-3" id="pageInfo">第1页，共1页</span>
                            <span class="text-muted" id="recordInfo">显示第1-15条，共0条记录</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <nav>
                            <ul class="pagination justify-content-end mb-0">
                                <li class="page-item" id="prevPage">
                                    <a class="page-link" href="#" onclick="changeLogsPage(window.app.logsCurrentPage - 1)">上一页</a>
                                </li>
                                <li class="page-item active" id="currentPageItem">
                                    <span class="page-link" id="currentPageSpan">1</span>
                                </li>
                                <li class="page-item" id="nextPage">
                                    <a class="page-link" href="#" onclick="changeLogsPage(window.app.logsCurrentPage + 1)">下一页</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
                </div>
                </div>
                </div>`;
                
                // 删除已存在的模态框
                const existingModal = document.getElementById('allLogsModal');
                if (existingModal) existingModal.remove();
                
                // 添加新模态框并显示
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 渲染日志数据
                renderLogsPage();
                
                const modal = new bootstrap.Modal(document.getElementById('allLogsModal'));
                modal.show();
            } else {
                console.log('暂无日志数据');
            }
        };
        
        // 渲染日志分页数据
        window.renderLogsPage = function() {
            if (!window.app || !window.app.allEvolutionLogs) return;
            
            const tbody = document.getElementById('allLogsTableBody');
            if (!tbody) return;
            
            // 修复排序：确保最新日志在前面
            const allLogs = [...window.app.allEvolutionLogs].sort((a, b) => {
                const timeA = new Date(a.timestamp || '1970-01-01').getTime();
                const timeB = new Date(b.timestamp || '1970-01-01').getTime();
                return timeB - timeA; // 降序排列，最新在前
            });
            
            // 计算分页
            const totalLogs = allLogs.length;
            const totalPages = Math.ceil(totalLogs / window.app.logsPerPage);
            const startIndex = (window.app.logsCurrentPage - 1) * window.app.logsPerPage;
            const endIndex = Math.min(startIndex + window.app.logsPerPage, totalLogs);
            const currentPageLogs = allLogs.slice(startIndex, endIndex);
            
            // 渲染表格数据
            tbody.innerHTML = currentPageLogs.map(log => {
                const time = new Date(log.timestamp).toLocaleString('zh-CN');
                let actionClass = 'secondary';
                let actionText = '变更';
                
                switch(log.action) {
                    case 'created':
                        actionClass = 'success';
                        actionText = '新增';
                        break;
                    case 'eliminated':
                        actionClass = 'danger';
                        actionText = '淘汰';
                        break;
                    case 'optimized':
                        actionClass = 'primary';
                        actionText = '优化';
                        break;
                    case 'updated':
                        actionClass = 'info';
                        actionText = '更新';
                        break;
                    case 'promoted':
                        actionClass = 'warning';
                        actionText = '晋级';
                        break;
                    case 'protected':
                        actionClass = 'info';
                        actionText = '保护';
                        break;
                    case 'evolved':
                        actionClass = 'primary';
                        actionText = '进化';
                        break;
                }
                
                return `
                    <tr>
                        <td class="text-muted">${time}</td>
                        <td><span class="badge bg-${actionClass}">${actionText}</span></td>
                        <td>${log.details}</td>
                    </tr>
                `;
            }).join('');
            
            // 更新分页信息
            const pageInfo = document.getElementById('pageInfo');
            const recordInfo = document.getElementById('recordInfo');
            const currentPageSpan = document.getElementById('currentPageSpan');
            const prevPage = document.getElementById('prevPage');
            const nextPage = document.getElementById('nextPage');
            
            if (pageInfo) pageInfo.textContent = `第${window.app.logsCurrentPage}页，共${totalPages}页`;
            if (recordInfo) recordInfo.textContent = `显示第${startIndex + 1}-${endIndex}条，共${totalLogs}条记录`;
            if (currentPageSpan) currentPageSpan.textContent = window.app.logsCurrentPage;
            
            // 更新按钮状态
            if (prevPage) {
                if (window.app.logsCurrentPage <= 1) {
                    prevPage.classList.add('disabled');
                } else {
                    prevPage.classList.remove('disabled');
                }
            }
            
            if (nextPage) {
                if (window.app.logsCurrentPage >= totalPages) {
                    nextPage.classList.add('disabled');
                } else {
                    nextPage.classList.remove('disabled');
                }
            }
        };
        
        // 切换日志页面
        window.changeLogsPage = function(page) {
            if (!window.app || !window.app.allEvolutionLogs) return;
            
            const totalPages = Math.ceil(window.app.allEvolutionLogs.length / window.app.logsPerPage);
            
            if (page < 1 || page > totalPages) return;
            
            window.app.logsCurrentPage = page;
            renderLogsPage();
        };
        
        // 确保app对象中的方法也能被全局访问
        window.app = window.app || {};
        
    </script>
    <!-- 实时监控脚本 -->
    <script src="/static/js/real_time_monitor.js"></script>
</body>
</html> 