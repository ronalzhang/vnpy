<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥—åˆ©ç³»ç»Ÿ - æ ¡é•¿çš„é‡åŒ–ç³»ç»Ÿ</title>
    <!-- æ·»åŠ favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- å¼•å…¥Bootstrap CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <style>
        body { 
            background-color: #f5f8fa;
        }
        .header {
            margin-bottom: 20px;
            border-bottom: 1px solid #e7e9ec;
            padding-bottom: 10px;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e7e9ec;
        }
        .text-profit {
            color: #28a745;
        }
        .text-loss {
            color: #dc3545;
        }
        .badge-success {
            background-color: #28a745;
        }
        .badge-warning {
            background-color: #ffc107;
        }
        .badge-danger {
            background-color: #dc3545;
        }
        .badge-info {
            background-color: #17a2b8;
        }
        .table th {
            background-color: #f8f9fa;
        }
        .stats-card {
            text-align: center;
            padding: 15px;
        }
        .stats-card .value {
            font-size: 24px;
            font-weight: bold;
        }
        .stats-card .label {
            font-size: 14px;
            color: #6c757d;
        }
        #log-container {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg" style="background: linear-gradient(135deg, #1677ff, #4096ff);">
        <div class="container-fluid">
            <div class="navbar-content">
                <!-- å·¦ä¾§ï¼šå“ç‰Œåå’Œç³»ç»ŸçŠ¶æ€ -->
                <div class="navbar-left">
                    <div class="navbar-brand-group">
                        <a class="navbar-brand" href="/">
                            <i class="fas fa-chart-line"></i>
                            æ ¡é•¿çš„é‡åŒ–ç³»ç»Ÿ
                        </a>
                        <div class="system-status">
                            <span class="status-dot offline" id="system-status-indicator"></span>
                            <span id="system-status-text">ç¦»çº¿</span>
                            <span id="current-time">2025/6/4 05:05:27</span>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šå¯¼èˆªèœå• -->
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home"></i>
                            <span class="nav-link-desktop-text">å¸‚åœºæ•°æ®</span>
                            <span class="nav-link-mobile-text">å¸‚åœº</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/quantitative.html">
                            <i class="fas fa-robot"></i>
                            <span class="nav-link-desktop-text">é‡åŒ–äº¤æ˜“</span>
                            <span class="nav-link-mobile-text">é‡åŒ–</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/arbitrage.html">
                            <i class="fas fa-exchange-alt"></i>
                            <span class="nav-link-desktop-text">å¥—åˆ©ç³»ç»Ÿ</span>
                            <span class="nav-link-mobile-text">å¥—åˆ©</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/operations-log.html">
                            <i class="fas fa-list-alt"></i>
                            <span class="nav-link-desktop-text">æ“ä½œæ—¥å¿—</span>
                            <span class="nav-link-mobile-text">æ—¥å¿—</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="header">
            <div class="row">
                <div class="col-md-6">
                    <h2><i class="fa fa-exchange"></i> æ ¡é•¿çš„å¥—åˆ©ç³»ç»Ÿ</h2>
                </div>
                <div class="col-md-6 text-end">
                    <div id="system-status" class="badge bg-success">è¿è¡Œä¸­</div>
                    <div id="last-update">æœ€åæ›´æ–°ï¼šåŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fa fa-dashboard"></i> å¥—åˆ©ç³»ç»Ÿä»ªè¡¨ç›˜</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="value" id="total-funds">Â¥0</div>
                                    <div class="label">æ€»èµ„é‡‘</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="value" id="available-funds">Â¥0</div>
                                    <div class="label">å¯ç”¨èµ„é‡‘</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="value" id="cross-opportunities">0</div>
                                    <div class="label">è·¨æ‰€å¥—åˆ©æœºä¼š</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="value" id="triangle-opportunities">0</div>
                                    <div class="label">ä¸‰è§’å¥—åˆ©æœºä¼š</div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12 text-center">
                                <button id="start-btn" class="btn btn-success me-2"><i class="fa fa-play"></i> å¯åŠ¨ç³»ç»Ÿ</button>
                                <button id="stop-btn" class="btn btn-danger me-2"><i class="fa fa-pause"></i> åœæ­¢ç³»ç»Ÿ</button>
                                <button id="settings-btn" class="btn btn-primary me-2"><i class="fa fa-cog"></i> ç³»ç»Ÿè®¾ç½®</button>
                                <button id="refresh-btn" class="btn btn-secondary"><i class="fa fa-refresh"></i> åˆ·æ–°æ•°æ®</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- è·¨æ‰€å¥—åˆ©æœºä¼š -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fa fa-building"></i> è·¨æ‰€å¥—åˆ©æœºä¼š</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“å¯¹</th>
                                        <th>ä¹°å…¥æ‰€</th>
                                        <th>å–å‡ºæ‰€</th>
                                        <th>å‡€æ”¶ç›Š</th>
                                        <th>æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="cross-arbitrage-data">
                                    <tr>
                                        <td colspan="5" class="text-center">åŠ è½½ä¸­...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸‰è§’å¥—åˆ©æœºä¼š -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fa fa-retweet"></i> ä¸‰è§’å¥—åˆ©æœºä¼š</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“æ‰€</th>
                                        <th>è·¯å¾„</th>
                                        <th>æ”¶ç›Šç‡</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="triangle-arbitrage-data">
                                    <tr>
                                        <td colspan="4" class="text-center">åŠ è½½ä¸­...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- æ´»è·ƒå¥—åˆ©ä»»åŠ¡ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fa fa-tasks"></i> æ´»è·ƒå¥—åˆ©ä»»åŠ¡</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ç±»å‹</th>
                                        <th>çŠ¶æ€</th>
                                        <th>å¼€å§‹æ—¶é—´</th>
                                    </tr>
                                </thead>
                                <tbody id="active-tasks-data">
                                    <tr>
                                        <td colspan="4" class="text-center">æš‚æ— æ´»è·ƒä»»åŠ¡</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¥—åˆ©å†å² -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fa fa-history"></i> å¥—åˆ©å†å²</h5>
                        <div class="pagination-controls" id="history-pagination">
                            <button class="btn btn-sm btn-outline-secondary" id="prev-page-btn" disabled>
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <span class="mx-2" id="page-info">ç¬¬1é¡µ</span>
                            <button class="btn btn-sm btn-outline-secondary" id="next-page-btn" disabled>
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“å¯¹</th>
                                        <th>äº¤æ˜“æ‰€</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ”¶ç›Š</th>
                                    </tr>
                                </thead>
                                <tbody id="history-data">
                                    <tr>
                                        <td colspan="4" class="text-center">æš‚æ— å†å²è®°å½•</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fa fa-terminal"></i> ç³»ç»Ÿæ—¥å¿—</h5>
                    </div>
                    <div class="card-body">
                        <div id="log-container">
                            <div class="log-entry">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ€å¯¹è¯æ¡†ï¼šå¥—åˆ©è¯¦æƒ… -->
    <div class="modal fade" id="arbitrage-detail-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fa fa-exchange-alt"></i> 
                        <span id="detail-title">å¥—åˆ©æœºä¼šè¯¦æƒ…</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fa fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯</h6>
                            <table class="table table-sm">
                                <tr><td>äº¤æ˜“å¯¹:</td><td id="detail-symbol">-</td></tr>
                                <tr><td>ä¹°å…¥äº¤æ˜“æ‰€:</td><td id="detail-buy-exchange">-</td></tr>
                                <tr><td>å–å‡ºäº¤æ˜“æ‰€:</td><td id="detail-sell-exchange">-</td></tr>
                                <tr><td>ä¹°å…¥ä»·æ ¼:</td><td id="detail-buy-price">-</td></tr>
                                <tr><td>å–å‡ºä»·æ ¼:</td><td id="detail-sell-price">-</td></tr>
                            </table>
                        </div>
                        
                        <!-- æ”¶ç›Šä¿¡æ¯ -->
                        <div class="col-md-6">
                            <h6 class="text-success"><i class="fa fa-chart-line"></i> æ”¶ç›Šåˆ†æ</h6>
                            <table class="table table-sm">
                                <tr><td>æ¯›æ”¶ç›Šç‡:</td><td id="detail-gross-profit">-</td></tr>
                                <tr><td>å‡€æ”¶ç›Šç‡:</td><td id="detail-net-profit">-</td></tr>
                                <tr><td>æ½œåœ¨æ”¶ç›Š:</td><td id="detail-profit-potential">-</td></tr>
                                <tr><td>äº¤æ˜“æ‰‹ç»­è´¹:</td><td id="detail-trading-fee">-</td></tr>
                                <tr><td>é¢„ä¼°æ»‘ç‚¹:</td><td id="detail-slippage">-</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <!-- æ—¶é—´ä¿¡æ¯ -->
                        <div class="col-md-6">
                            <h6 class="text-warning"><i class="fa fa-clock"></i> æ—¶é—´ä¿¡æ¯</h6>
                            <table class="table table-sm">
                                <tr><td>å‘ç°æ—¶é—´:</td><td id="detail-discovery-time">-</td></tr>
                                <tr><td>æœ€åæ›´æ–°:</td><td id="detail-last-update">-</td></tr>
                                <tr><td>è¿‡æœŸæ—¶é—´:</td><td id="detail-expiry-time">-</td></tr>
                                <tr><td>å‰©ä½™æ—¶é—´:</td><td id="detail-time-remaining">-</td></tr>
                            </table>
                        </div>
                        
                        <!-- é£é™©å’ŒæµåŠ¨æ€§ -->
                        <div class="col-md-6">
                            <h6 class="text-danger"><i class="fa fa-shield-alt"></i> é£é™©è¯„ä¼°</h6>
                            <table class="table table-sm">
                                <tr><td>é£é™©ç­‰çº§:</td><td id="detail-risk-level">-</td></tr>
                                <tr><td>æµåŠ¨æ€§è¯„åˆ†:</td><td id="detail-liquidity-score">-</td></tr>
                                <tr><td>æœ€å°äº¤æ˜“é¢:</td><td id="detail-min-amount">-</td></tr>
                                <tr><td>æœ€å¤§äº¤æ˜“é¢:</td><td id="detail-max-amount">-</td></tr>
                                <tr><td>è®¢å•ç°¿æ·±åº¦:</td><td id="detail-order-depth">-</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="execute-arbitrage-btn">
                        <i class="fa fa-play"></i> æ‰§è¡Œå¥—åˆ©
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ€å¯¹è¯æ¡†ï¼šç³»ç»Ÿè®¾ç½® -->
    <div class="modal fade" id="settings-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å¥—åˆ©ç³»ç»Ÿè®¾ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="settings-form">
                        <div class="mb-3">
                            <label for="total-funds-input" class="form-label">æ€»èµ„é‡‘ (USDT)</label>
                            <input type="number" class="form-control" id="total-funds-input" value="10000">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">èµ„é‡‘åˆ†é…æ¯”ä¾‹</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text">è·¨æ‰€å¥—åˆ©</span>
                                <input type="number" class="form-control" id="cross-ratio-input" value="60">
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="input-group">
                                <span class="input-group-text">ä¸‰è§’å¥—åˆ©</span>
                                <input type="number" class="form-control" id="triangle-ratio-input" value="40">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">äº¤æ˜“æ‰€</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exchange-binance" checked>
                                <label class="form-check-label" for="exchange-binance">Binance</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exchange-okx" checked>
                                <label class="form-check-label" for="exchange-okx">OKX</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exchange-bitget" checked>
                                <label class="form-check-label" for="exchange-bitget">Bitget</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="save-settings-btn">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let systemStatus = { running: false };
        let currentPage = 1;
        let totalPages = 1;
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        $(document).ready(function() {
            // åˆå§‹åŒ–UIäº‹ä»¶
            initUIEvents();
            
            // åŠ è½½åˆå§‹æ•°æ®
            refreshData();
            
            // æ¯120ç§’è‡ªåŠ¨åˆ·æ–°æ•°æ® (å¢åŠ åˆ·æ–°é—´éš”)
            setInterval(refreshData, 120000);
            
            // æ›´æ–°å½“å‰æ—¶é—´
            function updateTime() {
                const now = new Date();
                document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
            }
            updateTime();
            setInterval(updateTime, 1000);
            
            // ç¡®ä¿é¡µé¢åŠ è½½æ—¶çŠ¶æ€æŒ‡ç¤ºå™¨æ˜¾ç¤ºæ­£ç¡®
            const statusIndicator = document.getElementById('system-status-indicator');
            const statusText = document.getElementById('system-status-text');
            if (statusIndicator && statusText) {
                statusIndicator.className = 'status-dot offline';
                statusText.textContent = 'ç¦»çº¿';
            }
            
            // æ·»åŠ æ—¥å¿—
            addLog("ç³»ç»Ÿ", "å¥—åˆ©ç³»ç»Ÿç•Œé¢åˆå§‹åŒ–å®Œæˆ");
        });
        
        // åˆå§‹åŒ–UIäº‹ä»¶
        function initUIEvents() {
            // æŒ‰é’®äº‹ä»¶
            $("#start-btn").click(startSystem);
            $("#stop-btn").click(stopSystem);
            $("#refresh-btn").click(function() {
                $(this).data("manual-refresh", true);
                refreshData();
            });
            $("#settings-btn").click(showSettings);
            $("#save-settings-btn").click(saveSettings);
            
            // ç¦ç”¨åœæ­¢æŒ‰é’®ï¼ˆåˆå§‹çŠ¶æ€ï¼‰
            $("#stop-btn").prop("disabled", true);
            
            // ç»‘å®šåˆ†é¡µæŒ‰é’®äº‹ä»¶
            $("#prev-page-btn").click(function() {
                if (currentPage > 1) {
                    currentPage--;
                    loadHistoryData();
                }
            });
            
            $("#next-page-btn").click(function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadHistoryData();
                }
            });
        }
        
        // åˆ·æ–°æ•°æ®
        function refreshData() {
            // è®°å½•æœ€ååˆ·æ–°æ—¶é—´
            const now = new Date();
            const timeString = now.toTimeString().split(' ')[0];
            
            // åªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½å’Œæ‰‹åŠ¨åˆ·æ–°æ—¶æ·»åŠ åˆ·æ–°æ—¥å¿—
            if (!window.lastRefreshTime || ($("#refresh-btn").data("manual-refresh") === true)) {
                addLog("ç³»ç»Ÿ", "æ­£åœ¨åˆ·æ–°æ•°æ®...");
                $("#refresh-btn").data("manual-refresh", false);
            }
            window.lastRefreshTime = now;
            
            // è·å–ç³»ç»ŸçŠ¶æ€
            $.get("/api/arbitrage/status")
                .done(function(response) {
                    if (response.status === "success") {
                        updateStatusUI(response.data);
                    } else {
                        // é™é»˜å¤„ç†å¸¸è§„é”™è¯¯ï¼Œåªåœ¨æ‰‹åŠ¨åˆ·æ–°æ—¶æ˜¾ç¤º
                        if ($("#refresh-btn").data("manual-refresh") === true) {
                            addLog("é”™è¯¯", "è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥: " + response.message);
                        }
                    }
                })
                .fail(function(xhr, status, error) {
                    // åªè®°å½•è¿æ¥å¤±è´¥çš„é”™è¯¯
                    addLog("é”™è¯¯", "è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥: " + error);
                });
            
            // è·å–å¥—åˆ©æœºä¼š
            $.get("/api/arbitrage/opportunities")
                .done(function(response) {
                    if (response.status === "success") {
                        updateOpportunitiesUI(response.data);
                    }
                })
                .fail(function(xhr, status, error) {
                    // é™é»˜å¤„ç†ï¼Œé™¤éæ˜¯è¿æ¥é”™è¯¯
                    if (error && error !== "undefined") {
                        addLog("é”™è¯¯", "è·å–å¥—åˆ©æœºä¼šå¤±è´¥: " + error);
                    }
                });
            
            // è·å–æ´»è·ƒä»»åŠ¡
            $.get("/api/arbitrage/tasks")
                .done(function(response) {
                    if (response.status === "success") {
                        updateTasksUI(response.data);
                    }
                })
                .fail(function(xhr, status, error) {
                    // é™é»˜å¤„ç†ï¼Œé™¤éæ˜¯è¿æ¥é”™è¯¯
                    if (error && error !== "undefined") {
                        addLog("é”™è¯¯", "è·å–æ´»è·ƒä»»åŠ¡å¤±è´¥: " + error);
                    }
                });
            
            // è·å–å†å²è®°å½•ï¼ˆä¸åœ¨è¿™é‡Œè°ƒç”¨ï¼Œæ”¹ä¸ºç‹¬ç«‹å‡½æ•°ï¼‰
            loadHistoryData();
        }
        
        // æ›´æ–°çŠ¶æ€UI
        function updateStatusUI(status) {
            if (!status) {
                addLog("é”™è¯¯", "æ”¶åˆ°ç©ºçš„çŠ¶æ€æ•°æ®");
                return;
            }
            
            systemStatus = status;
            
            // æ›´æ–°çŠ¶æ€æ ‡ç­¾
            if (status.running) {
                $("#system-status").removeClass("bg-danger").addClass("bg-success").text("è¿è¡Œä¸­");
                $("#start-btn").prop("disabled", true);
                $("#stop-btn").prop("disabled", false);
            } else {
                $("#system-status").removeClass("bg-success").addClass("bg-danger").text("å·²åœæ­¢");
                $("#start-btn").prop("disabled", false);
                $("#stop-btn").prop("disabled", true);
            }
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            $("#last-update").text("æœ€åæ›´æ–°ï¼š" + (status.last_update || "æœªçŸ¥"));
            
            // æ›´æ–°èµ„é‡‘ä¿¡æ¯ - æ·»åŠ å®‰å…¨æ£€æŸ¥
            const totalFunds = status.total_funds !== undefined ? status.total_funds : 0;
            $("#total-funds").text("Â¥" + totalFunds.toFixed(2));
            
            // å®‰å…¨è·å–å¯ç”¨èµ„é‡‘
            let availableFunds = 0;
            if (status.available_funds) {
                const crossFunds = status.available_funds.cross_exchange || 0;
                const triangleFunds = status.available_funds.triangle || 0;
                availableFunds = crossFunds + triangleFunds;
            }
            $("#available-funds").text("Â¥" + availableFunds.toFixed(2));
            
            // æ›´æ–°æœºä¼šæ•°é‡ - æ·»åŠ å®‰å…¨æ£€æŸ¥
            $("#cross-opportunities").text(status.cross_opportunities || 0);
            $("#triangle-opportunities").text(status.triangle_opportunities || 0);
        }
        
        // æ›´æ–°å¥—åˆ©æœºä¼šUI
        function updateOpportunitiesUI(opportunities) {
            // ç¡®ä¿opportunitiesæ˜¯æ•°ç»„
            if (!Array.isArray(opportunities)) {
                opportunities = [];
                addLog("è­¦å‘Š", "æœªæ”¶åˆ°æœ‰æ•ˆçš„å¥—åˆ©æœºä¼šæ•°æ®");
            }
            
            // åˆ†ç¦»è·¨æ‰€å’Œä¸‰è§’å¥—åˆ©æœºä¼š
            const crossOpportunities = opportunities.filter(o => o && o.type === "cross_exchange");
            const triangleOpportunities = opportunities.filter(o => o && o.type === "triangle");
            
            // æ›´æ–°è·¨æ‰€å¥—åˆ©è¡¨æ ¼
            let crossHtml = "";
            if (crossOpportunities.length === 0) {
                crossHtml = "<tr><td colspan='6' class='text-center'>æš‚æ— å¥—åˆ©æœºä¼š</td></tr>";
            } else {
                crossOpportunities.forEach(opp => {
                    // å®‰å…¨è·å–å±æ€§ï¼Œæä¾›é»˜è®¤å€¼
                    const symbol = opp.symbol || "æœªçŸ¥";
                    const buyExchange = opp.buy_exchange || "æœªçŸ¥";
                    const sellExchange = opp.sell_exchange || "æœªçŸ¥";
                    const netProfitPct = opp.net_profit_pct || 0;
                    
                    // ğŸ”¥ ä¿®å¤ï¼šæ­£ç¡®å¤„ç†æ”¶ç›Šç‡æ˜¾ç¤º
                    const profitClass = netProfitPct > 0 ? "text-profit" : "text-loss";
                    const profitPercent = netProfitPct.toFixed(3) + "%";  // ç›´æ¥ä½¿ç”¨å‡€æ”¶ç›Šç‡ï¼Œä¸å†ä¹˜ä»¥100
                    
                    // ğŸ”¥ æ–°å¢ï¼šæ—¶é—´ä¿¡æ¯æ˜¾ç¤º
                    const timeRemaining = opp.time_remaining || 0;
                    const timeText = timeRemaining > 0 ? `${Math.floor(timeRemaining / 60)}m${timeRemaining % 60}s` : "å³å°†è¿‡æœŸ";
                    const timeClass = timeRemaining < 120 ? "text-danger" : "text-muted";
                    
                    // ğŸ”¥ æ–°å¢ï¼šè¯¦ç»†ä¿¡æ¯å·¥å…·æç¤º
                    const tooltipInfo = [
                        `å‘ç°æ—¶é—´: ${opp.discovery_time || "æœªçŸ¥"}`,
                        `ä¹°å…¥ä»·: ${opp.buy_price || "æœªçŸ¥"}`,
                        `å–å‡ºä»·: ${opp.sell_price || "æœªçŸ¥"}`,
                        `æ¯›æ”¶ç›Š: ${(opp.gross_profit_pct || 0).toFixed(3)}%`,
                        `æ‰‹ç»­è´¹: ${(opp.trading_fee_pct || 0).toFixed(1)}%`,
                        `é¢„ä¼°æ»‘ç‚¹: ${(opp.estimated_slippage || 0).toFixed(3)}%`,
                        `æµåŠ¨æ€§è¯„åˆ†: ${opp.liquidity_score || "æœªçŸ¥"}/10`,
                        `é£é™©ç­‰çº§: ${opp.risk_level || "æœªçŸ¥"}`,
                        `æœ€å°äº¤æ˜“: ${opp.min_trade_amount || 0} USDT`,
                        `æœ€å¤§äº¤æ˜“: ${opp.max_trade_amount || 0} USDT`
                    ].join("\\n");
                    
                    const opportunityId = `${buyExchange}_${sellExchange}_${symbol}`;
                    
                    crossHtml += `
                        <tr title="${tooltipInfo}">
                            <td><strong>${symbol}</strong></td>
                            <td><span class="badge bg-info">${buyExchange}</span></td>
                            <td><span class="badge bg-success">${sellExchange}</span></td>
                            <td class="${profitClass}">
                                <strong>${profitPercent}</strong><br>
                                <small class="text-muted">${(opp.profit_potential || 0).toFixed(2)} USDT</small>
                            </td>
                            <td class="${timeClass}">
                                <small>${timeText}</small><br>
                                <small class="text-muted">${opp.last_update || "æœªçŸ¥"}</small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary execute-btn" 
                                    data-type="cross_exchange" 
                                    data-id="${opportunityId}"
                                    title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯å’Œæ‰§è¡Œäº¤æ˜“">
                                    æ‰§è¡Œ
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            $("#cross-arbitrage-data").html(crossHtml);
            
            // æ›´æ–°ä¸‰è§’å¥—åˆ©è¡¨æ ¼
            let triangleHtml = "";
            if (triangleOpportunities.length === 0) {
                triangleHtml = "<tr><td colspan='4' class='text-center'>æš‚æ— ä¸‰è§’å¥—åˆ©æœºä¼š</td></tr>";
            } else {
                triangleOpportunities.forEach(opp => {
                    // å®‰å…¨è·å–å±æ€§ï¼Œæä¾›é»˜è®¤å€¼
                    const exchangeId = opp.exchange_id || "æœªçŸ¥";
                    const profitPercent = (opp.profit_percent || 0).toFixed(3) + "%";
                    const profitClass = (opp.profit_percent || 0) > 0 ? "text-profit" : "text-loss";
                    
                    // å®‰å…¨æ„å»ºè·¯å¾„å­—ç¬¦ä¸²
                    let pathStr = "BTC â†’ ETH â†’ USDT";
                    if (opp.steps && Array.isArray(opp.steps)) {
                        pathStr = opp.steps.map(s => (s.symbol || "æœªçŸ¥").replace("/", "â†’")).join(" â†’ ");
                    }
                    
                    // å®‰å…¨æ„å»ºID
                    let firstSymbol = "btc";
                    if (opp.path && Array.isArray(opp.path) && opp.path.length > 0) {
                        firstSymbol = opp.path[0].symbol || "btc";
                    }
                    const opportunityId = `${exchangeId}_${firstSymbol}`;
                    
                    triangleHtml += `
                        <tr>
                            <td><span class="badge bg-primary">${exchangeId}</span></td>
                            <td><small>${pathStr}</small></td>
                            <td class="${profitClass}"><strong>${profitPercent}</strong></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary execute-btn" 
                                    data-type="triangle" 
                                    data-id="${opportunityId}"
                                    title="ä¸‰è§’å¥—åˆ©æš‚æœªå®Œå…¨å®ç°">
                                    ç›‘æ§
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            $("#triangle-arbitrage-data").html(triangleHtml);
            
            // ç»‘å®šæ‰§è¡ŒæŒ‰é’®äº‹ä»¶
            $(".execute-btn").click(function() {
                const type = $(this).data("type");
                const id = $(this).data("id");
                
                // ğŸ”¥ æ–°å¢ï¼šå¦‚æœæ˜¯è·¨æ‰€å¥—åˆ©ï¼Œæ˜¾ç¤ºè¯¦æƒ…æ¨¡æ€æ¡†
                if (type === "cross_exchange") {
                    // æ‰¾åˆ°å¯¹åº”çš„å¥—åˆ©æœºä¼šæ•°æ®
                    const opportunity = crossOpportunities.find(opp => 
                        `${opp.buy_exchange}_${opp.sell_exchange}_${opp.symbol}` === id
                    );
                    
                    if (opportunity) {
                        showArbitrageDetail(opportunity);
                    } else {
                executeArbitrage(type, id);
                    }
                } else {
                    // ä¸‰è§’å¥—åˆ©ç›´æ¥æ‰§è¡Œï¼ˆæš‚æœªå®Œå…¨å®ç°ï¼‰
                    executeArbitrage(type, id);
                }
            });
        }
        
        // æ›´æ–°æ´»è·ƒä»»åŠ¡UI
        function updateTasksUI(tasks) {
            // ç¡®ä¿tasksæ˜¯æ•°ç»„
            if (!Array.isArray(tasks)) {
                tasks = [];
                addLog("è­¦å‘Š", "æœªæ”¶åˆ°æœ‰æ•ˆçš„ä»»åŠ¡æ•°æ®");
            }
            
            let html = "";
            if (tasks.length === 0) {
                html = "<tr><td colspan='4' class='text-center'>æš‚æ— æ´»è·ƒä»»åŠ¡</td></tr>";
            } else {
                tasks.forEach(task => {
                    // å®‰å…¨è·å–å±æ€§
                    const id = task.id || "æœªçŸ¥";
                    const type = task.type || "æœªçŸ¥";
                    const status = task.status || "æœªçŸ¥";
                    const startTime = task.start_time || "";
                    
                    const statusBadge = getStatusBadge(status);
                    
                    html += `
                        <tr>
                            <td>${id}</td>
                            <td>${getTypeName(type)}</td>
                            <td>${statusBadge}</td>
                            <td>${formatDateTime(startTime)}</td>
                        </tr>
                    `;
                });
            }
            $("#active-tasks-data").html(html);
        }
        
        // åŠ è½½å†å²æ•°æ®ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
        function loadHistoryData() {
            $.get(`/api/arbitrage/history?page=${currentPage}&per_page=20`)
                .done(function(response) {
                    if (response.status === "success") {
                        updateHistoryUI(response.data);
                        if (response.pagination) {
                            updatePagination(response.pagination);
                        }
                    } else {
                        addLog("é”™è¯¯", "è·å–å†å²è®°å½•å¤±è´¥: " + (response.message || "æœªçŸ¥é”™è¯¯"));
                    }
                })
                .fail(function(xhr, status, error) {
                    addLog("é”™è¯¯", "è·å–å†å²è®°å½•å¤±è´¥: " + error);
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    $("#history-data").html("<tr><td colspan='4' class='text-center text-danger'>åŠ è½½å¤±è´¥</td></tr>");
                });
        }
        
        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination(pagination) {
            currentPage = pagination.page;
            totalPages = pagination.pages;
            
            // æ›´æ–°é¡µé¢ä¿¡æ¯
            $("#page-info").text(`ç¬¬${currentPage}é¡µï¼Œå…±${totalPages}é¡µ`);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            $("#prev-page-btn").prop("disabled", currentPage <= 1);
            $("#next-page-btn").prop("disabled", currentPage >= totalPages);
        }
        
        // æ›´æ–°å†å²è®°å½•UI
        function updateHistoryUI(history) {
            // ç¡®ä¿historyæ˜¯æ•°ç»„
            if (!Array.isArray(history)) {
                history = [];
                addLog("è­¦å‘Š", "æœªæ”¶åˆ°æœ‰æ•ˆçš„å†å²æ•°æ®");
            }
            
            let html = "";
            if (history.length === 0) {
                html = "<tr><td colspan='4' class='text-center'>æš‚æ— å†å²è®°å½•</td></tr>";
            } else {
                history.forEach(item => {
                    // å®‰å…¨è·å–å±æ€§å¹¶æ ¼å¼åŒ–æ˜¾ç¤º
                    const symbol = item.symbol || "æœªçŸ¥";
                    const buyExchange = item.buy_exchange || "æœªçŸ¥";
                    const sellExchange = item.sell_exchange || "æœªçŸ¥";
                    const status = item.status || "æœªçŸ¥";
                    
                    const statusBadge = getStatusBadge(status);
                    let profit = "æœªçŸ¥";
                    let profitClass = "";
                    let exchangeInfo = "æœªçŸ¥";
                    
                    // æ ¼å¼åŒ–äº¤æ˜“æ‰€ä¿¡æ¯
                    if (buyExchange !== "æœªçŸ¥" && sellExchange !== "æœªçŸ¥") {
                        exchangeInfo = `${buyExchange} â†’ ${sellExchange}`;
                    }
                    
                    // æ ¼å¼åŒ–æ”¶ç›Šä¿¡æ¯
                    if (item.profit !== undefined && item.profit_percent !== undefined) {
                        const profitVal = parseFloat(item.profit) || 0;
                        const profitPercentVal = parseFloat(item.profit_percent) || 0;
                        profit = `${profitVal.toFixed(2)} (${profitPercentVal.toFixed(2)}%)`;
                        profitClass = profitVal > 0 ? "text-profit" : "text-loss";
                    }
                    
                    html += `
                        <tr>
                            <td>${symbol}</td>
                            <td>${exchangeInfo}</td>
                            <td>${statusBadge}</td>
                            <td class="${profitClass}">${profit}</td>
                        </tr>
                    `;
                });
            }
            $("#history-data").html(html);
        }
        
        // å¯åŠ¨ç³»ç»Ÿ
        function startSystem() {
            $.post("/api/arbitrage/start", function(response) {
                if (response.status === "success") {
                    addLog("ç³»ç»Ÿ", "å¥—åˆ©ç³»ç»Ÿå¯åŠ¨æˆåŠŸ");
                    refreshData();
                } else {
                    addLog("é”™è¯¯", "å¥—åˆ©ç³»ç»Ÿå¯åŠ¨å¤±è´¥: " + response.message);
                }
            });
        }
        
        // åœæ­¢ç³»ç»Ÿ
        function stopSystem() {
            $.post("/api/arbitrage/stop", function(response) {
                if (response.status === "success") {
                    addLog("ç³»ç»Ÿ", "å¥—åˆ©ç³»ç»Ÿåœæ­¢æˆåŠŸ");
                    refreshData();
                } else {
                    addLog("é”™è¯¯", "å¥—åˆ©ç³»ç»Ÿåœæ­¢å¤±è´¥: " + response.message);
                }
            });
        }
        
        // æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
        function showSettings() {
            // åŠ è½½å½“å‰é…ç½®
            $.get("/api/arbitrage/config", function(response) {
                if (response.status === "success") {
                    const config = response.data;
                    
                    // è®¾ç½®è¡¨å•å€¼
                    $("#total-funds-input").val(config.total_funds);
                    $("#cross-ratio-input").val(config.allocation_ratio.cross_exchange * 100);
                    $("#triangle-ratio-input").val(config.allocation_ratio.triangle * 100);
                    
                    // è®¾ç½®äº¤æ˜“æ‰€å¤é€‰æ¡†
                    $("#exchange-binance").prop("checked", config.exchanges.includes("binance"));
                    $("#exchange-okx").prop("checked", config.exchanges.includes("okx"));
                    $("#exchange-bitget").prop("checked", config.exchanges.includes("bitget"));
                    
                    // æ˜¾ç¤ºå¯¹è¯æ¡†
                    const modal = new bootstrap.Modal(document.getElementById("settings-modal"));
                    modal.show();
                } else {
                    addLog("é”™è¯¯", "è·å–å¥—åˆ©é…ç½®å¤±è´¥: " + response.message);
                }
            });
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            // éªŒè¯è¾“å…¥
            const totalFunds = parseFloat($("#total-funds-input").val());
            const crossRatio = parseFloat($("#cross-ratio-input").val()) / 100;
            const triangleRatio = parseFloat($("#triangle-ratio-input").val()) / 100;
            
            if (isNaN(totalFunds) || totalFunds <= 0) {
                alert("æ€»èµ„é‡‘å¿…é¡»æ˜¯æ­£æ•°");
                return;
            }
            
            if (isNaN(crossRatio) || isNaN(triangleRatio) || 
                crossRatio < 0 || triangleRatio < 0 || 
                Math.abs(crossRatio + triangleRatio - 1.0) > 0.001) {
                alert("èµ„é‡‘åˆ†é…æ¯”ä¾‹ä¹‹å’Œå¿…é¡»ä¸º100%");
                return;
            }
            
            // è·å–é€‰ä¸­çš„äº¤æ˜“æ‰€
            const exchanges = [];
            if ($("#exchange-binance").prop("checked")) exchanges.push("binance");
            if ($("#exchange-okx").prop("checked")) exchanges.push("okx");
            if ($("#exchange-bitget").prop("checked")) exchanges.push("bitget");
            
            if (exchanges.length < 2) {
                alert("å¿…é¡»é€‰æ‹©è‡³å°‘ä¸¤ä¸ªäº¤æ˜“æ‰€");
                return;
            }
            
            // åˆ›å»ºé…ç½®å¯¹è±¡
            const config = {
                total_funds: totalFunds,
                allocation_ratio: {
                    cross_exchange: crossRatio,
                    triangle: triangleRatio
                },
                exchanges: exchanges
            };
            
            // å‘é€é…ç½®æ›´æ–°è¯·æ±‚
            $.ajax({
                url: "/api/arbitrage/config",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(config),
                success: function(response) {
                    if (response.status === "success") {
                        addLog("ç³»ç»Ÿ", "å¥—åˆ©é…ç½®æ›´æ–°æˆåŠŸ");
                        
                        // å…³é—­å¯¹è¯æ¡†
                        bootstrap.Modal.getInstance(document.getElementById("settings-modal")).hide();
                        
                        // åˆ·æ–°æ•°æ®
                        refreshData();
                    } else {
                        addLog("é”™è¯¯", "å¥—åˆ©é…ç½®æ›´æ–°å¤±è´¥: " + response.message);
                    }
                }
            });
        }
        
        // ğŸ”¥ æ–°å¢ï¼šæ˜¾ç¤ºå¥—åˆ©è¯¦æƒ…æ¨¡æ€æ¡†
        function showArbitrageDetail(opportunity) {
            // å¡«å……è¯¦æƒ…æ•°æ®
            $("#detail-title").text(`${opportunity.symbol} è·¨æ‰€å¥—åˆ©æœºä¼š`);
            $("#detail-symbol").text(opportunity.symbol || "-");
            $("#detail-buy-exchange").html(`<span class="badge bg-info">${opportunity.buy_exchange || "-"}</span>`);
            $("#detail-sell-exchange").html(`<span class="badge bg-success">${opportunity.sell_exchange || "-"}</span>`);
            $("#detail-buy-price").text(`${opportunity.buy_price || 0} USDT`);
            $("#detail-sell-price").text(`${opportunity.sell_price || 0} USDT`);
            
            // æ”¶ç›Šä¿¡æ¯
            $("#detail-gross-profit").html(`<span class="text-success">${(opportunity.gross_profit_pct || 0).toFixed(3)}%</span>`);
            $("#detail-net-profit").html(`<span class="text-success"><strong>${(opportunity.net_profit_pct || 0).toFixed(3)}%</strong></span>`);
            $("#detail-profit-potential").html(`<span class="text-success"><strong>${(opportunity.profit_potential || 0).toFixed(2)} USDT</strong></span>`);
            $("#detail-trading-fee").text(`${(opportunity.trading_fee_pct || 0).toFixed(1)}%`);
            $("#detail-slippage").text(`${(opportunity.estimated_slippage || 0).toFixed(3)}%`);
            
            // æ—¶é—´ä¿¡æ¯
            $("#detail-discovery-time").text(opportunity.discovery_time || "-");
            $("#detail-last-update").text(opportunity.last_update || "-");
            $("#detail-expiry-time").text(opportunity.expiry_time || "-");
            
            const timeRemaining = opportunity.time_remaining || 0;
            const timeText = timeRemaining > 0 ? `${Math.floor(timeRemaining / 60)}åˆ†${timeRemaining % 60}ç§’` : "å·²è¿‡æœŸ";
            const timeClass = timeRemaining < 120 ? "text-danger" : "text-success";
            $("#detail-time-remaining").html(`<span class="${timeClass}"><strong>${timeText}</strong></span>`);
            
            // é£é™©å’ŒæµåŠ¨æ€§
            const riskLevel = opportunity.risk_level || "æœªçŸ¥";
            const riskClass = riskLevel === "low" ? "text-success" : riskLevel === "medium" ? "text-warning" : "text-danger";
            $("#detail-risk-level").html(`<span class="badge ${riskClass === 'text-success' ? 'bg-success' : riskClass === 'text-warning' ? 'bg-warning' : 'bg-danger'}">${riskLevel}</span>`);
            
            $("#detail-liquidity-score").html(`<strong>${opportunity.liquidity_score || 0}</strong>/10`);
            $("#detail-min-amount").text(`${opportunity.min_trade_amount || 0} USDT`);
            $("#detail-max-amount").text(`${opportunity.max_trade_amount || 0} USDT`);
            $("#detail-order-depth").text(`${(opportunity.order_book_depth || 0).toLocaleString()} USDT`);
            
            // ç»‘å®šæ‰§è¡ŒæŒ‰é’®äº‹ä»¶
            $("#execute-arbitrage-btn").off("click").on("click", function() {
                const opportunityId = `${opportunity.buy_exchange}_${opportunity.sell_exchange}_${opportunity.symbol}`;
                executeArbitrage("cross_exchange", opportunityId);
                $("#arbitrage-detail-modal").modal("hide");
            });
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            $("#arbitrage-detail-modal").modal("show");
        }
        
        // æ‰§è¡Œå¥—åˆ©
        function executeArbitrage(type, opportunityId) {
            const data = {
                type: type,
                opportunity_id: opportunityId
            };
            
            $.ajax({
                url: "/api/arbitrage/execute",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.status === "success") {
                        addLog("å¥—åˆ©", `${getTypeName(type)}å¥—åˆ©æ‰§è¡Œå·²æäº¤ï¼Œä»»åŠ¡ID: ${response.data?.task_id || "æœªçŸ¥"}`);
                        setTimeout(refreshData, 2000);
                    } else {
                        addLog("é”™è¯¯", `æ‰§è¡Œå¥—åˆ©å¤±è´¥: ${response.message}`);
                    }
                },
                error: function(xhr, status, error) {
                    addLog("é”™è¯¯", `æ‰§è¡Œå¥—åˆ©å¤±è´¥: ${error}`);
                }
            });
        }
        
        // æ·»åŠ æ—¥å¿—åˆ°æ—¥å¿—é¢æ¿
        function addLog(type, message) {
            const now = new Date();
            const timeString = now.toTimeString().split(' ')[0];
            const logEntry = `[${timeString}] [${type}] ${message}`;
            
            // è·å–å½“å‰æ—¥å¿—å†…å®¹
            const $logContainer = $("#log-container");
            const $logs = $logContainer.find("div");
            
            // å¦‚æœæ—¥å¿—è¶…è¿‡100æ¡ï¼Œåˆ é™¤æœ€æ—§çš„æ—¥å¿—
            if ($logs.length >= 100) {
                $logs.first().remove();
            }
            
            // æ·»åŠ æ–°æ—¥å¿—
            $logContainer.append(`<div class="log-entry">${logEntry}</div>`);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            $logContainer.scrollTop($logContainer[0].scrollHeight);
            
            // åªåœ¨æ§åˆ¶å°æ‰“å°é”™è¯¯æ—¥å¿—ï¼Œå‡å°‘æ§åˆ¶å°è¾“å‡º
            if (type === "é”™è¯¯") {
                console.error(logEntry);
            }
        }
        
        // è·å–çŠ¶æ€æ ‡ç­¾
        function getStatusBadge(status) {
            let badgeClass = "bg-secondary";
            let statusText = status;
            
            switch (status) {
                case "executing":
                    badgeClass = "bg-primary";
                    statusText = "æ‰§è¡Œä¸­";
                    break;
                case "pending":
                    badgeClass = "bg-warning";
                    statusText = "ç­‰å¾…ä¸­";
                    break;
                case "completed":
                    badgeClass = "bg-success";
                    statusText = "å·²å®Œæˆ";
                    break;
                case "failed":
                    badgeClass = "bg-danger";
                    statusText = "å¤±è´¥";
                    break;
            }
            
            return `<span class="badge ${badgeClass}">${statusText}</span>`;
        }
        
        // è·å–ç±»å‹åç§°
        function getTypeName(type) {
            switch (type) {
                case "cross_exchange":
                    return "è·¨æ‰€å¥—åˆ©";
                case "triangle":
                    return "ä¸‰è§’å¥—åˆ©";
                default:
                    return type;
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return "æœªçŸ¥";
            
            try {
                // å°è¯•è§£ææ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²
                const date = new Date(dateTimeStr);
                return date.toLocaleString();
            } catch (e) {
                return dateTimeStr;
            }
        }
    </script>
</body>
</html> 